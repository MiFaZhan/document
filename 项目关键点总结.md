# 项目关键点总结

本项目是基于若依(RuoYi)框架的Spring Boot后台管理系统。以下是需要掌握的关键技术点和模式。

---

## 1. LambdaQueryWrapper 查询条件构造 ⭐⭐⭐

**说明**: 使用MyBatis-Plus的LambdaQueryWrapper进行类型安全的查询条件构造，这是项目中最常用的查询方式。

**典型用法**:
```java
LambdaQueryWrapper<TbInsurancePreorder> queryWrapper = new LambdaQueryWrapper<>();
queryWrapper.like(preorderCode != null, TbInsurancePreorder::getPreOrderCode, preorderCode)
        .eq(status != null, TbInsurancePreorder::getStatus, status)
        .orderByDesc(TbInsurancePreorder::getCreateTime);
Page<TbInsurancePreorder> pageResult = tbInsurancePreorderMapper.selectPage(page, queryWrapper);
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePreorderServiceImpl.java:101-106`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsuranceRepairServiceImpl.java:141-148`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePolicyServiceImpl.java:599-612`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbVehicleAccessoryServiceImpl.java:73-110`

---

## 2. Elasticsearch 搜索查询 ⭐⭐⭐

**说明**: 项目使用Elasticsearch进行全文搜索，通过BoolQueryBuilder构造复杂查询条件。

**典型用法**:
```java
BoolQueryBuilder boolQueryBuilder = QueryBuilders.boolQuery();
boolQueryBuilder.must(QueryBuilders.multiMatchQuery(keyWord, fields));
boolQueryBuilder.must(QueryBuilders.termQuery("orderStatus", status));
NativeSearchQuery build = nativeSearchQuery.withQuery(boolQueryBuilder).build();
SearchHits<TbInsurancePolicy> search = elasticsearchRestTemplate.search(build, TbInsurancePolicy.class);
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/GlobalSearchServiceImpl.java:127-156`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePolicyServiceImpl.java:146-189`

**核心服务**: `IGlobalSearchService` 提供统一的Elasticsearch查询封装

---

## 3. 权限控制 (@PreAuthorize) ⭐⭐⭐

**说明**: 使用Spring Security的@PreAuthorize注解进行方法级权限控制，配合自定义的PermissionService。

**典型用法**:
```java
@PreAuthorize("@ss.hasPermi('lvguan:policy:query')")
@GetMapping("/list")
public TableDataInfo list(...) { ... }
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:72`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePreorderController.java:35`
- `ruoyi-framework/src/main/java/com/ruoyi/framework/web/service/PermissionService.java:27-40`

**权限服务**: `PermissionService` (bean名称: "ss") 提供权限验证方法

---

## 4. 分页处理 ⭐⭐

**说明**: 使用PageHelper进行分页，在Controller中调用startPage()，然后通过getDataTable()返回分页结果。

**典型用法**:
```java
// Controller中
startPage();
List<InsurancePolicyVO> list = tbInsurancePolicyService.selectPolicyList(insuranceResearchDTO);
Long totalHits = SearchContext.getTotalHits();
SearchContext.clear();
return getDataTable(list, totalHits);

// Service中使用MyBatis-Plus分页
Page<TbInsurancePreorder> page = new Page<>(globalSearchService.getPageable().getPageNumber(), 
                                             globalSearchService.getPageable().getPageSize());
```

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/utils/PageUtils.java:18-26`
- `ruoyi-common/src/main/java/com/ruoyi/common/core/controller/BaseController.java:50-52, 76-94`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:93-101`

---

## 5. VO/DTO 对象转换 ⭐⭐

**说明**: 使用VO(视图对象)和DTO(数据传输对象)进行数据封装和转换，避免直接暴露实体类。

**典型模式**:
- Controller层接收DTO，返回VO
- Service层进行Entity与VO/DTO之间的转换
- 使用静态工厂方法或转换方法进行对象转换

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/dto/` - DTO定义
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/vo/` - VO定义
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/vo/accessory/AccessoryVO.java:201-225` - 静态转换方法示例

---

## 6. 事务处理 (@Transactional) ⭐⭐

**说明**: 在Service层的增删改方法上使用@Transactional注解保证数据一致性。

**典型用法**:
```java
@Transactional
@Override
public int insert${ClassName}(${ClassName} ${className}) { ... }
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePreorderServiceImpl.java:22`
- `ruoyi-generator/src/main/resources/vm/java/serviceImpl.java.vm:65` - 代码生成模板

---

## 7. Excel导入导出 ⭐⭐

**说明**: 使用ExcelUtil工具类进行Excel的导入导出，配合@Excel注解定义导出字段。

**典型用法**:
```java
// 导出
ExcelUtil<TbInsurancePolicyVo> util = new ExcelUtil<>(TbInsurancePolicyVo.class);
util.exportExcel(response, list, "保单");

// 导入
ExcelUtil<InsurancePolicyImportVo> util = new ExcelUtil<>(InsurancePolicyImportVo.class);
List<InsurancePolicyImportVo> list = util.importExcel(file.getInputStream(), 1);
```

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/utils/poi/ExcelUtil.java`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:237-238`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePolicyServiceImpl.java:644-682`

---

## 8. 文件上传下载 ⭐⭐

**说明**: 使用FileUploadUtils进行文件上传，通过MultipartFile接收文件。

**典型用法**:
```java
@PostMapping("/upload")
public AjaxResult uploadFile(@RequestParam("file") MultipartFile file) {
    String filePath = RuoYiConfig.getUploadPath();
    String fileName = FileUploadUtils.upload(filePath, file);
    return AjaxResult.success(fileName);
}
```

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/utils/file/FileUploadUtils.java:159-176`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:172-188`
- `ruoyi-admin/src/main/java/com/ruoyi/web/controller/common/CommonController.java:75-96`

---

## 9. 部门权限过滤 ⭐⭐⭐

**说明**: 项目特有的业务逻辑，根据用户所属部门(保司/供应商)自动过滤数据。

**核心方法**:
- `deptService.verifyProviderIdAndDeptId(BoolQueryBuilder)` - ES查询过滤
- `deptService.verifyCompanyOrOther(LambdaQueryWrapper)` - MyBatis查询过滤

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/DeptServiceImpl.java:29-88`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePolicyServiceImpl.java:163, 599`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/GlobalSearchServiceImpl.java:130`

**业务规则**:
- 保司用户: 只能查看本保司的保单 (tenantId过滤)
- 供应商用户: 只能查看本供应商的订单 (providerId过滤)

---

## 10. ServiceImpl 继承模式 ⭐⭐⭐

**说明**: Service实现类继承MyBatis-Plus的ServiceImpl，获得基础的CRUD能力。

**典型模式**:
```java
@Service
public class TbInsurancePolicyServiceImpl extends ServiceImpl<TbInsurancePolicyMapper, TbInsurancePolicy> 
    implements ITbInsurancePolicyService {
    
    @Autowired
    private TbInsurancePolicyMapper tbInsurancePolicyMapper; // 仍需要注入用于自定义方法
}
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/TbInsurancePolicyServiceImpl.java:70`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/DeptServiceImpl.java:23`
- 所有 `*ServiceImpl.java` 文件都遵循此模式

---

## 11. 统一响应格式 ⭐⭐

**说明**: 使用R<T>或AjaxResult作为统一响应格式。

**响应类型**:
- `R<T>`: 泛型响应，用于返回具体数据类型
- `AjaxResult`: Map类型的响应，灵活性更高
- `TableDataInfo`: 分页响应格式

**典型用法**:
```java
return R.ok(data);                    // 成功返回数据
return R.fail("错误信息");             // 失败返回
return getDataTable(list, total);     // 分页返回
```

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/core/domain/R.java`
- `ruoyi-common/src/main/java/com/ruoyi/common/core/domain/AjaxResult.java`
- `ruoyi-common/src/main/java/com/ruoyi/common/core/controller/BaseController.java:76-158`

---

## 12. 操作日志记录 (@Log) ⭐

**说明**: 使用@Log注解记录操作日志，通过AOP自动记录到数据库。

**典型用法**:
```java
@Log(title = "导入保单", businessType = BusinessType.IMPORT)
@PostMapping("/import")
public R<Boolean> importInsurance(...) { ... }
```

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/annotation/Log.java`
- `ruoyi-framework/src/main/java/com/ruoyi/framework/aspectj/LogAspect.java`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:200, 233`

---

## 13. Controller 继承 BaseController ⭐⭐⭐

**说明**: 所有Controller都继承BaseController，获得通用方法支持。

**提供的方法**:
- `startPage()` - 设置分页
- `getDataTable()` - 返回分页数据
- `success()/error()` - 返回响应
- `getUserId()/getDeptId()/getUsername()` - 获取当前用户信息

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/core/controller/BaseController.java`
- 所有Controller类都继承此类

---

## 14. MyBatis Plus 配置和使用 ⭐⭐

**说明**: 项目同时使用MyBatis和MyBatis-Plus，通过配置支持两者共存。

**关键配置**:
- 逻辑删除: `logic-delete-value: 1, logic-not-delete-value: 0`
- 自动填充: createTime, updateTime等字段自动填充
- 驼峰转换: `mapUnderscoreToCamelCase: true`

**代码位置**:
- `ruoyi-admin/src/main/resources/application.yml:172-179`
- `ruoyi-framework/src/main/java/com/ruoyi/framework/config/MyBatisPlusConfig.java:153-171`

---

## 15. SearchContext 线程上下文 ⭐

**说明**: 用于在Service层存储查询总数，在Controller层获取。主要用于ES查询返回总数。

**典型用法**:
```java
// Service层
SearchContext.setTotalHits(search.getTotalHits());

// Controller层
Long totalHits = SearchContext.getTotalHits();
SearchContext.clear();
return getDataTable(list, totalHits);
```

**代码位置**:
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/utls/SearchContext.java`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/service/impl/GlobalSearchServiceImpl.java:120`
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:96-101`

---

## 16. Swagger API文档 ⭐

**说明**: 使用Swagger3进行API文档生成，通过注解描述接口。

**典型用法**:
```java
@Api("保单管理")
@RestController
@RequestMapping("/lvguan/policy")
public class TbInsurancePolicyController {
    
    @ApiOperation("查询保险单列表")
    @ApiImplicitParams({
        @ApiImplicitParam(name = "keyword", value = "关键词", ...)
    })
    @GetMapping("/list")
    public TableDataInfo list(...) { ... }
}
```

**代码位置**:
- 所有Controller类都使用Swagger注解
- `ruoyi-platform/src/main/java/com/ruoyi/lvguan/controller/TbInsurancePolicyController.java:47-83`

---

## 17. SecurityUtils 安全工具类 ⭐⭐

**说明**: 提供获取当前登录用户信息的方法。

**常用方法**:
- `SecurityUtils.getLoginUser()` - 获取登录用户
- `SecurityUtils.getDeptId()` - 获取部门ID
- `SecurityUtils.getUserId()` - 获取用户ID
- `SecurityUtils.getUsername()` - 获取用户名

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/utils/SecurityUtils.java`
- 项目中大量使用，用于权限判断和数据过滤

---

## 18. Redis 缓存 ⭐⭐⭐

**说明**: 项目使用Redis进行缓存，主要用于Token存储、字典缓存、系统配置缓存、在线用户管理和接口限流。

**核心工具类**: `RedisCache` - 封装了Redis的常用操作

**主要使用场景**:

1. **Token存储** - 用户登录信息存储在Redis中
```java
// TokenService中使用
redisCache.setCacheObject(userKey, loginUser, expireTime, TimeUnit.MINUTES);
LoginUser user = redisCache.getCacheObject(userKey);
```

2. **字典缓存** - 系统字典数据缓存
```java
// DictUtils中使用
RedisCache.setCacheObject(getCacheKey(key), dictDatas);
List<SysDictData> dictDatas = getDictCache(key);
```

3. **接口限流** - 使用Redis + Lua脚本实现
```java
// RateLimiterAspect中使用
@RateLimiter(key = "test", count = 10, time = 60)
Long number = redisTemplate.execute(limitScript, keys, count, time);
```

4. **在线用户管理** - 存储和管理在线用户信息

**代码位置**:
- `ruoyi-common/src/main/java/com/ruoyi/common/core/redis/RedisCache.java` - Redis工具类
- `ruoyi-framework/src/main/java/com/ruoyi/framework/config/RedisConfig.java` - Redis配置
- `ruoyi-framework/src/main/java/com/ruoyi/framework/web/service/TokenService.java:54-154` - Token存储
- `ruoyi-common/src/main/java/com/ruoyi/common/utils/DictUtils.java:29-48` - 字典缓存
- `ruoyi-framework/src/main/java/com/ruoyi/framework/aspectj/RateLimiterAspect.java:49-74` - 接口限流

**配置位置**:
- `ruoyi-admin/src/main/resources/application-dev.yml:28-49` - Redis连接配置

**Redis常用操作**:
- `setCacheObject(key, value, timeout, timeUnit)` - 设置缓存对象
- `getCacheObject(key)` - 获取缓存对象
- `deleteObject(key)` - 删除缓存
- `expire(key, timeout, timeUnit)` - 设置过期时间
- `hasKey(key)` - 判断key是否存在

