# 绿色保单管理平台需求分析文档

## 1. 项目概述

### 1.1 项目背景
绿色保单管理平台是一个基于若依(RuoYi)框架开发的保险业务管理系统，主要服务于保险公司的车险业务管理。该平台通过数字化手段实现保险单、车辆配件、理赔维修等全流程管理，提升保险业务效率并降低运营成本。

### 1.2 项目目标
- **数字化管理**：实现保险业务全流程数字化管理
- **质量追溯**：建立完整的配件质量追溯体系，包含区块链技术支持
- **数据分析**：提供数据大屏和统计分析功能，支持业务决策
- **多租户支持**：支持多保险公司的SaaS化部署
- **搜索优化**：集成Elasticsearch实现高效的全文搜索

### 1.3 技术架构
- **后端框架**：Spring Boot 2.5.15 + MyBatis Plus
- **数据库**：MySQL 8.0 + Redis + Elasticsearch 7.x
- **安全框架**：Spring Security + JWT
- **文档工具**：Swagger 3.0
- **区块链**：支持配件数据上链存储

---

## 2. 核心业务模块详细需求

### 2.1 报案管理模块

#### 2.1.1 模块概述
报案管理模块是保险理赔业务的入口，负责处理客户报案、记录事故信息、管理报案状态等核心功能。

#### 2.1.2 功能需求

**2.1.2.1 报案信息录入**
- **必填字段**：
  - 保单号（insurancePolicyCode）：必须关联已存在的保单
  - 事故描述（accidentDescribe）：文字描述事故情况
  - 事故地点（accidentPlace）：事故发生地点
  - 出险时间（handleTime）：格式 yyyy-MM-dd HH:mm:ss
  - 处理方式（treatmentWay）：
    - "0"：无需换件
    - "1"：换件
  - 照片文件（photoFiles）：至少一张，不能为空
  - 引导员姓名（guideName）：负责接单的引导员
- **自动生成字段**：
  - 报案编号（claimCode）：格式 "CLAIM-" + 时间戳
  - 报案ID（id）：自增主键
  - 车牌号（carPlate）：从关联保单自动获取
- **初始状态**：创建时默认状态为"0"（待接单）

**2.1.2.2 报案信息查询**
- **查询条件**：
  - 关键词（keyword）：支持模糊搜索
  - 手机号（phone）：仅customer角色用户可查询，其他角色自动置空
  - 状态（status）：0-待接单，1-送修中，2-已完结
  - 保司名称（companyName）：
    - 管理员可指定查询
    - 非管理员自动从用户部门获取
- **查询结果包含**：
  - 报案基本信息
  - 关联保单信息（车主姓名、车牌号、保单号等）
  - 报案状态

**2.1.2.3 报案详情查询**
- **查询方式**：支持通过报案ID或报案编号查询
- **返回信息**：
  - 报案基本信息
  - 关联保单完整信息
  - 报案照片列表（photoFiles）
  - 关联订单信息（如有）：
    - 维修厂名称（repairFactory）
    - 维修厂地址（factoryAddress）
    - 维修厂电话（factoryPhone）

**2.1.2.4 报案信息修改**
- **可修改字段**：
  - 事故描述（accidentDescribe）
  - 事故地点（accidentPlace）
  - 处理方式（treatmentWay）
  - 出险时间（handleTime）
  - 状态（status）
- **业务规则**：
  - 如果处理方式改为"0"（无需换件），状态自动设置为"2"（已完结）
  - 否则使用传入的状态值

**2.1.2.5 报案状态管理**
- **状态枚举**：
  - 0：待接单（PENDING）
  - 1：送修中（REPAIRING）
  - 2：已完结（COMPLETED）
- **状态更新**：支持通过报案编号（claimCode）更新状态

**2.1.2.6 报案照片管理**
- **照片存储**：通过TbInsuranceClaimPhoto表关联存储
- **照片关联**：一个报案可关联多张照片
- **照片字段**：photoFileUrl（文件ID或URL）

**2.1.2.7 权限控制**
- **列表查询**：`system:claim:list`
- **详情查询**：`system:claim:detail`
- **新增报案**：`system:claim:add`
- **修改报案**：`system:claim:update`
- **角色限制**：
  - customer角色：只能通过手机号查询自己的报案
  - 其他角色：根据部门权限过滤数据

#### 2.1.3 数据字段详细说明

| 字段名                 | 类型            | 必填  | 说明    | 备注                     |
| ------------------- | ------------- | --- | ----- | ---------------------- |
| id                  | Long          | 是   | 报案ID  | 自增主键                   |
| insurancePolicyCode | String        | 是   | 保单号   | 关联tb_insurance_policy表 |
| carPlate            | String        | 否   | 车牌号   | 从保单自动获取                |
| accidentDescribe    | String        | 是   | 事故描述  | 文字描述                   |
| accidentPlace       | String        | 是   | 事故地点  | 地点信息                   |
| status              | String        | 是   | 状态    | 0-待接单，1-送修中，2-已完结      |
| treatmentWay        | String        | 是   | 处理方式  | 0-无需换件，1-换件            |
| handleTime          | LocalDateTime | 是   | 出险时间  | 格式：yyyy-MM-dd HH:mm:ss |
| claimCode           | String        | 是   | 报案编号  | 自动生成：CLAIM-时间戳         |
| guideName           | String        | 是   | 引导员姓名 | 接单引导员                  |

---

### 2.2 保险单管理模块

#### 2.2.1 模块概述
管理保险单的全生命周期，包括保单信息录入、查询、状态跟踪等功能。

#### 2.2.2 功能需求

**2.2.2.1 保单信息管理**
- **核心字段**：
  - 保单号（insurancePolicyCode）：唯一标识，支持搜索
  - 保司名称（insuranceCompany）：保险公司名称
  - 保单类型（insurancePolicyType）：使用字典值
  - 循寻码（traceableCode）：可追溯编码，支持搜索
  - 车牌号（licensePlateNumber）：支持搜索
  - 车架号（vin）：VIN码，支持搜索
  - 品牌类型（brandType）：车辆品牌
  - 车主姓名（vehicleOwnerName）：支持模糊搜索
  - 车主手机号（vehicleOwnerPhonenumber）：支持精确搜索
  - 保险开始时间（insuranceStartTime）
  - 保险结束时间（insuranceEndTime）
  - 保单状态（insurancePolicyStatus）：使用字典值
  - 保单详情文件（insurancePolicyDetail）：文件路径

**2.2.2.2 保单查询功能**
- **搜索字段**（Elasticsearch索引）：
  - insurancePolicyCode（保单号）
  - vehicleOwnerName（车主姓名）
  - vehicleOwnerPhonenumber（车主手机号）
  - licensePlateNumber（车牌号）
  - vin（车架号）
  - traceableCode（循寻码）
- **搜索方式**：多字段匹配查询，支持模糊搜索

**2.2.2.3 数据同步功能**
- 支持从保险公司系统同步保单数据
- 同步记录存储在tb_data_sync_record表

#### 2.2.3 数据字段详细说明

| 字段名                     | 类型     | 必填  | 说明     | 搜索支持     |
| ----------------------- | ------ | --- | ------ | -------- |
| id                      | Long   | 是   | 主键ID   | 否        |
| insurancePolicyCode     | String | 是   | 保单号    | 是（ES）    |
| insuranceCompany        | String | 是   | 保司名称   | 否        |
| insurancePolicyType     | String | 否   | 保单类型   | 否        |
| traceableCode           | String | 否   | 循寻码    | 是（ES）    |
| licensePlateNumber      | String | 是   | 车牌号    | 是（ES）    |
| vin                     | String | 是   | 车架号    | 是（ES）    |
| brandType               | String | 否   | 品牌类型   | 否        |
| vehicleOwnerName        | String | 是   | 车主姓名   | 是（ES，模糊） |
| vehicleOwnerPhonenumber | String | 是   | 车主手机号  | 是（ES）    |
| insuranceStartTime      | String | 否   | 保险开始时间 | 否        |
| insuranceEndTime        | String | 否   | 保险结束时间 | 否        |
| insurancePolicyStatus   | String | 否   | 保单状态   | 否        |
| insurancePolicyDetail   | String | 否   | 保单详情文件 | 否        |

---

### 2.3 车辆配件管理模块

#### 2.3.1 模块概述
管理车辆配件的全生命周期，包括配件信息、质检数据、价格管理、物流跟踪等。

#### 2.3.2 功能需求

**2.3.2.1 配件基础信息管理**
- **必填字段**：
  - 配件名称（name）：支持搜索
  - OE码（oeCode）：配件编码，支持搜索
  - 适用车型（vehicleModel）：必填
  - 配件品质（quality）：必填
  - 质保期（warrantyPeriod）：必填，日期类型
  - 质检时间（qualityInspectionTime）：必填
- **可选字段**：
  - 厂商单位（manufacturer）
  - 配件品牌（brand）
  - 产地（origin）
  - 计数单位（unit）
  - 数量（quantity）：默认1
  - 配件类型（accessoryType）：钣金件/大灯

**2.3.2.2 配件价格管理**
- **三级价格体系**：
  - 供应商单价（providerUnitPrice）：供应商报价
  - 采购部单价（buyUnitPrice）：采购部定价
  - 对外单价（externalUnitPrice）：销售部定价
- **总价计算**：amount = 单价 × 数量

**2.3.2.3 配件质检管理**

**钣金件质检项目**：
- 外观查验（visibleSurface）
- 漆厚测量（paintThicknessMeasurement）
- 金属板厚度（metalPlateThickness）
- 合车查验（fitmentInspection）
- 尺寸（size）
- 内表面（innerSurface）
- 安装机构（installationMechanism）

**大灯质检项目**：
- 通电点亮（lampPowerOn）
- 灯具外观（lampAppearance）
- 灯具密封性（lampSealing）

**质检类型**：
- 前质检（preQuality）：合格/不合格
- 前质检数据（preQualityData）：详细质检数据
- 前质检Hash（preQualityHash）：区块链哈希值
- 前质检员ID（preQualityId）
- 抽检数据（samplingData）
- 抽检Hash（samplingHash）
- 抽检人ID（samplingId）
- 供应商准入数据（permitTestData）
- 供应商准入Hash（permitTestHash）
- 供应商准入质检人ID（permitTestId）

**2.3.2.4 配件状态管理**
- **状态枚举**（StatusEnum.ACCESSORY_*）：
  - 0：初始状态（ACCESSORY_INIT）
  - 1：待发货（ACCESSORY_WAIT_SEND）
  - 2：已发货（ACCESSORY_HAS_SENT）
  - 3：已收货（ACCESSORY_HAS_RECEIVED）

**2.3.2.5 配件关联信息**
- 保单号（insurancePolicyCode）：关联保单
- 保单ID（policyId）
- 出险ID（accidentId）
- 报案号（textMessageContent）：报案短信内容
- 订单号（orderNumber）
- 预订单ID（preorderId）
- 供应商ID（providerId）
- 车架号（vin）
- 车牌号（plateNumber）

**2.3.2.6 配件物流管理**
- 物流单号（deliveryNumber）
- 物流状态（deliveryStatus）

**2.3.2.7 配件区块链存证**
- 区块链哈希（txHash）：配件数据上链哈希
- 各质检环节的Hash值单独存储

**2.3.2.8 配件查询功能**
- **搜索字段**（Elasticsearch）：
  - name（配件名称）
  - oeCode（OE码）
  - brand（配件品牌）
  - insurancePolicyCode（保单号）
  - textMessageContent（报案号）
- **查询条件**：
  - 关键词（keyword）：多字段匹配
  - 状态（status）：配件状态筛选
  - 日期范围（startDate/endDate）：按质保期筛选
  - 排序：默认按质检时间升序

**2.3.2.9 配件附件管理**
- 配件图片（accessoryPicture）：配件照片ID
- 附件（attachment）：其他附件文件

#### 2.3.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 | 搜索支持 |
|--------|------|------|------|----------|
| id | Long | 是 | 主键ID | 否 |
| name | String | 是 | 配件名称 | 是（ES） |
| oeCode | String | 是 | OE码 | 是（ES） |
| vehicleModel | String | 是 | 适用车型 | 否 |
| manufacturer | String | 否 | 厂商单位 | 否 |
| quality | String | 是 | 配件品质 | 否 |
| warrantyPeriod | LocalDate | 是 | 质保期 | 否 |
| quantity | Integer | 否 | 数量 | 否 |
| unit | String | 否 | 计数单位 | 否 |
| amount | String | 否 | 总价 | 否 |
| accessoryType | String | 否 | 配件类型 | 否 |
| status | Long | 否 | 状态 | 否 |
| providerUnitPrice | String | 否 | 供应商单价 | 否 |
| buyUnitPrice | String | 否 | 采购部单价 | 否 |
| externalUnitPrice | String | 否 | 对外单价 | 否 |

---

### 2.4 配件订单管理模块

#### 2.4.1 模块概述
管理配件订单的全流程，包括订单创建、状态跟踪、物流管理等。

#### 2.4.2 功能需求

**2.4.2.1 订单基础信息**
- **必填字段**：
  - 修理厂联系方式（factoryPhone）：NotNull验证
- **核心字段**：
  - 报案短信内容（textMessageContent）：支持搜索
  - 引导员姓名（guideName）
  - 引导员接收时间（guideReceiveTime）
  - 引导员到达时间（guideArriveTime）
  - 保单号（insurancePolicyCode）：支持搜索
  - 车牌号（plateNumber）：支持搜索
  - 车架号（vin）：支持搜索
  - 送修维修厂（repairFactory）
  - 车型（vehicleModel）
  - 联系方式（phone）
  - 销售单号（salesOrderNumber）
  - 保险公司（insuranceCompany）
  - 运输方式（transportMode）
  - 修理厂地址（repairFactoryAddress）
  - 付款方式（payMode）
  - 是否开票（isInvoice）：Boolean，默认false

**2.4.2.2 订单状态管理**
- **状态枚举**（StatusEnum.ORDER_*）：
  - 0：待发货（ORDER_WAIT_SEND）
  - 1：已发货（ORDER_HAS_SENT）
  - 2：已收货（ORDER_HAS_RECEIVED）
  - 3：已完结（ORDER_FINISH）

**2.4.2.3 订单关联信息**
- 案件ID（orderId）
- 供应商ID（providerId）
- 保单ID（policyId）
- 报案编号（claimCode）
- 预订单ID（preorderId）
- 租户ID（tenantId）

**2.4.2.4 订单文件管理**
- 维修单照片（repairOrderFile）
- 附件（attachment）
- 金额（amount）

**2.4.2.5 订单查询功能**
- **搜索字段**（Elasticsearch）：
  - insurancePolicyCode（保单号）
  - vin（车架号）
  - plateNumber（车牌号）
  - textMessageContent（报案短信内容）
- **查询条件**：
  - 关键词（keyword）
  - 状态（status）：订单状态筛选
- **排序**：按引导员接收时间（guideReceiveTime）升序

**2.4.2.6 订单时间管理**
- 下单时间（submitOrderTime）：LocalDateTime类型

#### 2.4.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 | 搜索支持 |
|--------|------|------|------|----------|
| id | String | 是 | 订单ID | 否 |
| textMessageContent | String | 否 | 报案短信内容 | 是（ES） |
| insurancePolicyCode | String | 否 | 保单号 | 是（ES） |
| plateNumber | String | 否 | 车牌号 | 是（ES） |
| vin | String | 否 | 车架号 | 是（ES） |
| repairFactory | String | 否 | 送修维修厂 | 否 |
| factoryPhone | String | 是 | 修理厂联系方式 | 否 |
| status | Integer | 否 | 订单状态 | 否 |
| claimCode | String | 否 | 报案编号 | 否 |
| amount | String | 否 | 金额 | 否 |

---

### 2.5 预订单管理模块

#### 2.5.1 模块概述
管理配件预订单的创建、审批流程，支持多级审批和价格管理。

#### 2.5.2 功能需求

**2.5.2.1 预订单创建**
- **自动生成字段**：
  - 预订单号（preOrderCode）：格式 "YDD" + 时间戳
- **关联信息**：
  - 保单号（policyCode）：从保单获取
  - 案件号（claimCode）：关联报案
  - 车主联系方式（vehicleOwnerPhone）：从保单自动获取
- **基础信息**：
  - 联系方式（phone）
  - 运输方式（transportationWay）
  - 维修企业地址（fixCompanyAddress）
  - 支付方式（paidWay）
  - 是否开票（isInvoice）：Integer类型

**2.5.2.2 预订单状态管理**
- **状态枚举**（StatusEnum.PREORDER_*）：
  - 0：预购单初始状态（PREORDER_INIT）
  - 1：销售部第一次确认（PREORDER_SALE_CONFIRM_1）
  - 2：采购部下单（PREORDER_PURCHASE_ORDER）
  - 3：供应商报价（PREORDER_PROVIDER_PRICE）
  - 4：采购部第一次确认（PREORDER_PURCHASE_PRICE）
  - 5：销售部报价（PREORDER_SALE_PRICE）
  - 6：保司确认（PREORDER_INSURANCE_CONFIRM）
  - 7：销售部第二次确认（PREORDER_SALE_CONFIRM_2）

**2.5.2.3 预订单查询**
- **查询条件**：
  - 预订单号（preorder_code）：精确匹配
  - 状态（status）：状态筛选
- **返回信息**：
  - 预订单基本信息
  - 关联保单信息
  - 关联报案信息
  - 配件列表

**2.5.2.4 预订单配件管理**
- 一个预订单可包含多个配件
- 配件信息存储在tb_insurance_preorder_accessory表
- 支持配件的增删改查

#### 2.5.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 预订单ID |
| policyCode | String | 是 | 保单号 |
| claimCode | String | 是 | 案件号 |
| preOrderCode | String | 是 | 预订单号 |
| phone | String | 否 | 联系方式 |
| vehicleOwnerPhone | String | 否 | 车主联系方式 |
| transportationWay | String | 否 | 运输方式 |
| fixCompanyAddress | String | 否 | 维修企业地址 |
| paidWay | String | 否 | 支付方式 |
| isInvoice | Integer | 否 | 是否开票 |
| status | Integer | 是 | 当前状态 |

---

### 2.6 供应商订单管理模块

#### 2.6.1 模块概述
管理与供应商的订单往来，包括报价、发货、收货等流程。

#### 2.6.2 功能需求

**2.6.2.1 供应商订单创建**
- **关联信息**：
  - 供应商ID（providerId）
  - 预订单ID（preorderId）
  - 配件ID（accessoryId）
- **订单信息**：
  - 配件名称（accessoryName）
  - 配件数量（accessoryAmount）
  - 供应商报价（providerUnitPrice）：报价×100存储
  - 车牌号（plateNumber）
  - 预订单号（preorderCode）

**2.6.2.2 供应商订单状态管理**
- **状态枚举**（StatusEnum.PROVIDER_ORDER_*）：
  - 0：初始未报价（PROVIDER_ORDER_INIT）
  - 1：已报价（PROVIDER_ORDER_HAS_PRICE）
  - 2：待发货（PROVIDER_ORDER_WAIT_SENT）
  - 3：已发货（PROVIDER_ORDER_HAS_SENT）
  - 4：已收货（PROVIDER_ORDER_HAS_RECEIVED）

**2.6.2.3 供应商报价管理**
- 供应商可对订单进行报价
- 报价金额需要乘以100存储（避免小数精度问题）

#### 2.6.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | String | 是 | 主键ID |
| providerId | Long | 是 | 供应商ID |
| preorderId | Long | 是 | 预订单ID |
| accessoryId | Long | 是 | 配件ID |
| accessoryName | String | 否 | 配件名称 |
| accessoryAmount | Long | 否 | 配件数量 |
| providerUnitPrice | String | 否 | 供应商报价 |
| plateNumber | String | 否 | 车牌号 |
| preorderCode | String | 否 | 预订单号 |
| status | Integer | 是 | 状态 |

---

### 2.7 保险维修管理模块

#### 2.7.1 模块概述
管理车辆维修全流程，包括维修单创建、状态跟踪、照片管理等。

#### 2.7.2 功能需求

**2.7.2.1 维修单创建**
- **自动生成字段**：
  - 维修单号（repairCode）
- **关联信息**：
  - 预订单号（preorderCode）
  - 关联预订单和保单
- **基础信息**：
  - 接单人（acceptor）
  - 维修厂（repairFactory）
  - 维修厂地址（factoryAddress）
  - 维修厂电话（factoryPhone）

**2.7.2.2 维修状态管理**
- **状态枚举**（StatusEnum.REPAIR_*）：
  - 0：待收货（REPAIR_WAIT_RECEIVE）
  - 1：维修中（REPAIR_REPAIRING）
  - 2：维修完成（REPAIR_FINISH）

**2.7.2.3 维修照片管理**
- **维修前照片**：
  - 周围照片（surroundPhotoIds）：多张
  - 损伤照片（damagePhotoId）：单张
  - 仪表盘照片（dashboardPhotoId）：单张
- **维修后照片**：
  - 完成周围照片（completeSurroundPhotoIds）：多张
  - 完成损伤照片（completeDamagePhotoId）：单张
  - 完成仪表盘照片（completeDashboardPhotoId）：单张

**2.7.2.4 维修单查询**
- **查询条件**：支持多条件组合查询
- **返回信息**：
  - 维修单基本信息
  - 关联预订单信息
  - 关联保单信息
  - 配件列表
  - 维修前后照片对比

#### 2.7.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 维修单ID |
| repairCode | String | 是 | 维修单号 |
| preorderCode | String | 是 | 预订单号 |
| status | Integer | 是 | 状态 |
| acceptor | String | 否 | 接单人 |
| repairFactory | String | 否 | 维修厂 |
| factoryAddress | String | 否 | 维修厂地址 |
| factoryPhone | String | 否 | 维修厂电话 |

---

### 2.8 全局搜索模块

#### 2.8.1 模块概述
基于Elasticsearch实现的跨模块全文搜索功能，支持关键词搜索和搜索建议。

#### 2.8.2 功能需求

**2.8.2.1 全局搜索功能**
- **搜索范围**：同时搜索保单、配件、配件订单三个模块
- **搜索字段配置**：

**保单搜索字段**：
- insurancePolicyCode（保单号）
- vehicleOwnerName（车主姓名）
- vehicleOwnerPhonenumber（车主手机号）
- licensePlateNumber（车牌号）
- vin（车架号）
- traceableCode（循寻码）

**配件搜索字段**：
- oeCode（OE码）

**配件订单搜索字段**：
- insurancePolicyCode（保单号）
- vin（车架号）
- plateNumber（车牌号）
- textMessageContent（报案短信内容）

**2.8.2.2 搜索算法**
- **多字段匹配**：使用multiMatchQuery实现多字段同时搜索
- **短语匹配提升**：完全匹配的短语结果权重提升2倍
- **部门权限过滤**：根据用户部门自动过滤搜索结果

**2.8.2.3 搜索建议功能**
- **前缀搜索字段**：
  - oeCode（OE码）
  - accidentCode（事故号）
  - textMessageContent（报案短信内容）
  - insurancePolicyCode（保单号）
  - traceableCode（循寻码）
  - licensePlateNumber（车牌号）
  - vin（车架号）
  - vehicleOwnerName（车主姓名）
  - vehicleOwnerPhonenumber（车主手机号）
- **返回规则**：
  - 最多返回10条建议
  - 自动去重
  - 只返回包含关键词的字段值

**2.8.2.4 搜索结果返回**
- **返回结构**：
  ```json
  {
    "accessoryVOList": [],      // 配件列表
    "insurancePolicyVOList": [], // 保单列表
    "accessoryOrderVOList": []  // 配件订单列表
  }
  ```
- **分页支持**：支持分页查询
- **总数统计**：返回总命中数

**2.8.2.5 权限控制**
- **搜索权限**：`lvguan:global:list`
- **部门过滤**：非管理员用户只能看到本部门数据

#### 2.8.3 搜索字段详细说明

| 模块 | 字段名 | 字段说明 | 搜索类型 |
|------|--------|----------|----------|
| 保单 | insurancePolicyCode | 保单号 | 精确/模糊 |
| 保单 | vehicleOwnerName | 车主姓名 | 模糊 |
| 保单 | vehicleOwnerPhonenumber | 车主手机号 | 精确 |
| 保单 | licensePlateNumber | 车牌号 | 精确/模糊 |
| 保单 | vin | 车架号 | 精确/模糊 |
| 保单 | traceableCode | 循寻码 | 精确/模糊 |
| 配件 | oeCode | OE码 | 精确/模糊 |
| 配件订单 | insurancePolicyCode | 保单号 | 精确/模糊 |
| 配件订单 | vin | 车架号 | 精确/模糊 |
| 配件订单 | plateNumber | 车牌号 | 精确/模糊 |
| 配件订单 | textMessageContent | 报案短信内容 | 模糊 |

---

### 2.9 数据大屏模块

#### 2.9.1 模块概述
提供业务数据的可视化展示，支持多维度数据统计和分析。

#### 2.9.2 功能需求

**2.9.2.1 顶部关键指标**
- **接口**：`/lvguan/dashboard/topdata`
- **返回数据**：TitleVO列表
- **指标类型**：关键业务指标汇总

**2.9.2.2 累计减损金额情况**
- **接口**：`/lvguan/dashboard/lossamount`
- **返回数据**：BrandTypeVO列表
- **统计维度**：按品牌类型统计减损金额

**2.9.2.3 地区数据分布**
- **接口**：`/lvguan/dashboard/regiondata`
- **返回数据**：RegionDataVO列表
- **统计维度**：按地区统计业务数据

**2.9.2.4 品牌型号占比**
- **接口**：`/lvguan/dashboard/brandtype`
- **返回数据**：BrandTypeVO列表
- **统计维度**：品牌型号分布占比

**2.9.2.5 配件类型占比**
- **接口**：`/lvguan/dashboard/parttype`
- **返回数据**：PartTypeDistributionVO列表
- **统计维度**：配件类型分布占比

**2.9.2.6 近30天保险销售前5**
- **接口**：`/lvguan/dashboard/top5`
- **返回数据**：Top5InsuranceSalesVO列表
- **统计维度**：时间范围：近30天，排序：销售数量

**2.9.2.7 保司保单数据统计**
- **接口**：`/lvguan/dashboard/componyAndPolicyData`
- **返回数据**：CompanyAndPolicyVO
- **统计内容**：
  - 保司保单数
  - 保司新增保单数
  - 保司保费下降总额

**2.9.2.8 权限控制**
- 所有大屏接口使用`@PermitAll`，无需权限验证

---

### 2.10 保险公司管理模块

#### 2.10.1 模块概述
管理合作的保险公司信息，包括接口配置和数据同步设置。

#### 2.10.2 功能需求

**2.10.2.1 保险公司信息管理**
- **基础信息**：
  - 保司名称（insuranceCompanyName）
  - 联系电话（phone）
- **接口配置**：
  - 接口地址（interfaceUrl）
  - APIKey（apiKey）
  - APISecret（apiSecret）
- **同步配置**：
  - 同步时间（syncTime）
  - 同步状态（syncStatus）：字典值

**2.10.2.2 数据同步功能**
- 支持定时从保险公司系统同步数据
- 同步记录存储在tb_data_sync_record表
- **同步数据类型**：
  - 1：保单
  - 2：配件
  - 3：配件订单
- **同步结果**：
  - 1：成功
  - 2：失败

#### 2.10.3 数据字段详细说明

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 主键ID |
| insuranceCompanyName | String | 是 | 保司名称 |
| interfaceUrl | String | 否 | 接口地址 |
| apiKey | String | 否 | APIKey |
| apiSecret | String | 否 | APISecret |
| syncTime | Date | 否 | 同步时间 |
| syncStatus | String | 否 | 同步状态 |
| phone | String | 否 | 联系电话 |
| tenantId | Long | 否 | 租户号 |

---

## 3. 业务流程详细说明

### 3.1 保险理赔完整业务流程

```
1. 客户报案
   ├─ 录入报案信息（事故描述、地点、时间等）
   ├─ 上传事故照片（至少一张）
   ├─ 关联保单（通过保单号）
   └─ 自动生成报案编号（CLAIM-时间戳）

2. 案件分配
   ├─ 分配引导员（guideName）
   ├─ 记录引导员接收时间
   └─ 记录引导员到达时间

3. 确定处理方式
   ├─ 换件（treatmentWay=1）
   │   └─ 进入预订单流程
   └─ 无需换件（treatmentWay=0）
       └─ 直接完结（status=2）

4. 预订单创建（如需换件）
   ├─ 创建预订单（自动生成预订单号）
   ├─ 添加配件需求列表
   └─ 初始状态：0（PREORDER_INIT）

5. 预订单审批流程（7级审批）
   ├─ 1. 销售部第一次确认（status=1）
   ├─ 2. 采购部下单（status=2）
   ├─ 3. 供应商报价（status=3）
   ├─ 4. 采购部第一次确认（status=4）
   ├─ 5. 销售部报价（status=5）
   ├─ 6. 保司确认（status=6）
   └─ 7. 销售部第二次确认（status=7）

6. 供应商订单管理
   ├─ 创建供应商订单
   ├─ 供应商报价（status=1）
   ├─ 待发货（status=2）
   ├─ 已发货（status=3）
   └─ 已收货（status=4）

7. 配件质检流程
   ├─ 前质检
   │   ├─ 记录质检数据
   │   ├─ 生成质检Hash
   │   └─ 上链存储
   ├─ 抽检（可选）
   │   ├─ 记录抽检数据
   │   ├─ 生成抽检Hash
   │   └─ 上链存储
   └─ 供应商准入检测
       ├─ 记录准入数据
       ├─ 生成准入Hash
       └─ 上链存储

8. 配件订单创建
   ├─ 关联预订单
   ├─ 关联配件列表
   ├─ 记录维修厂信息
   └─ 初始状态：0（待发货）

9. 配件发货收货
   ├─ 配件状态：待发货（1）
   ├─ 配件状态：已发货（2）
   └─ 配件状态：已收货（3）

10. 维修单创建
    ├─ 关联预订单
    ├─ 记录维修厂信息
    ├─ 上传维修前照片
    └─ 初始状态：0（待收货）

11. 维修执行
    ├─ 状态：待收货（0）
    ├─ 状态：维修中（1）
    └─ 状态：维修完成（2）

12. 维修完成
    ├─ 上传维修后照片
    ├─ 对比维修前后照片
    └─ 更新报案状态为已完结（2）
```

### 3.2 配件质量管控流程

```
1. 供应商准入
   ├─ 供应商资质审核
   ├─ 供应商准入检测
   ├─ 记录准入数据
   └─ 生成准入Hash上链

2. 配件入库
   ├─ 前质检
   ├─ 记录基础信息
   └─ 生成前质检Hash上链

3. 定期抽检
   ├─ 随机抽取配件
   ├─ 进行抽检
   ├─ 记录抽检数据
   └─ 生成抽检Hash上链

4. 质量追溯
   ├─ 通过Hash值验证数据完整性
   ├─ 查看完整质检记录
   └─ 追溯配件全生命周期
```

---

## 4. 权限控制详细说明

### 4.1 角色定义

| 角色 | 说明 | 数据权限 |
|------|------|----------|
| admin | 管理员 | 可查看所有数据，可指定保司查询 |
| customer | 客户 | 只能通过手机号查询自己的报案 |
| 其他角色 | 普通用户 | 根据部门权限过滤数据 |

### 4.2 功能权限列表

| 模块 | 功能 | 权限标识 |
|------|------|----------|
| 报案管理 | 列表查询 | system:claim:list |
| 报案管理 | 详情查询 | system:claim:detail |
| 报案管理 | 新增报案 | system:claim:add |
| 报案管理 | 修改报案 | system:claim:update |
| 预订单 | 列表查询 | system:preorder:list |
| 预订单 | 详情查询 | system:preorder:query |
| 预订单 | 新增预订单 | system:preorder:add |
| 预订单 | 修改预订单 | system:preorder:edit |
| 维修单 | 列表查询 | system:repair:list |
| 维修单 | 详情查询 | system:repair:query |
| 维修单 | 新增维修单 | system:repair:add |
| 维修单 | 修改维修单 | system:repair:edit |
| 全局搜索 | 搜索 | lvguan:global:list |

---

## 5. 数据存储策略

### 5.1 MySQL存储
- **业务数据**：所有业务表存储在MySQL
- **关系数据**：表之间的关联关系
- **基础数据**：字典、配置等基础数据

### 5.2 Elasticsearch存储
- **索引配置**：
  - tb_insurance_policy：保单索引
  - tb_vehicle_accessory：配件索引
  - tb_vehicle_accessory_order：配件订单索引（通过AccessoryOrderRepositoryDTO）
- **搜索字段**：配置了自定义分析器（custom_ngram_analyzer）
- **同步机制**：通过ESController手动同步或定时同步

### 5.3 Redis存储
- **会话管理**：用户登录会话
- **缓存数据**：热点数据缓存
- **临时数据**：临时存储

### 5.4 区块链存储
- **存储内容**：配件质检数据的Hash值
- **存储字段**：
  - txHash：配件主Hash
  - preQualityHash：前质检Hash
  - samplingHash：抽检Hash
  - permitTestHash：供应商准入Hash

---

## 6. 接口规范

### 6.1 RESTful API设计
- **基础路径**：`/api/v1`
- **业务路径**：`/lvguan/{module}`
- **HTTP方法**：
  - GET：查询
  - POST：新增
  - PUT：修改
  - DELETE：删除

### 6.2 统一响应格式
```json
{
  "code": 200,
  "msg": "操作成功",
  "data": {}
}
```

### 6.3 分页响应格式
```json
{
  "total": 100,
  "rows": []
}
```

### 6.4 错误处理
- **业务异常**：返回具体错误信息
- **系统异常**：返回通用错误提示
- **参数验证**：使用@Valid和@NotNull等注解

---

## 7. 非功能性需求

### 7.1 性能需求
- **响应时间**：页面响应时间不超过3秒
- **搜索性能**：Elasticsearch搜索响应时间不超过1秒
- **并发支持**：支持1000+并发用户访问
- **数据处理**：支持百万级数据量的查询和统计

### 7.2 安全需求
- **身份认证**：基于JWT的用户认证机制
- **权限控制**：细粒度的功能权限控制
- **数据加密**：敏感数据传输和存储加密
- **审计日志**：完整的操作日志记录
- **区块链安全**：配件数据的不可篡改性保证

### 7.3 可用性需求
- **系统可用性**：99.5%以上的系统可用性
- **数据备份**：定期数据备份和恢复机制
- **容错处理**：系统异常的优雅处理
- **监控告警**：系统状态监控和异常告警

### 7.4 扩展性需求
- **多租户架构**：支持多保险公司独立部署（tenantId字段）
- **微服务化**：模块化设计，支持独立扩展
- **接口标准化**：标准化的API接口设计
- **配置化管理**：业务规则和流程的配置化

---

## 8. 数据字典

### 8.1 报案状态字典
| 值 | 说明 |
|----|------|
| 0 | 待接单 |
| 1 | 送修中 |
| 2 | 已完结 |

### 8.2 处理方式字典
| 值 | 说明 |
|----|------|
| 0 | 无需换件 |
| 1 | 换件 |

### 8.3 预订单状态字典
| 值 | 说明 |
|----|------|
| 0 | 预购单初始状态 |
| 1 | 销售部第一次确认 |
| 2 | 采购部下单 |
| 3 | 供应商报价 |
| 4 | 采购部第一次确认 |
| 5 | 销售部报价 |
| 6 | 保司确认 |
| 7 | 销售部第二次确认 |

### 8.4 配件状态字典
| 值 | 说明 |
|----|------|
| 0 | 初始状态 |
| 1 | 待发货 |
| 2 | 已发货 |
| 3 | 已收货 |

### 8.5 供应商订单状态字典
| 值 | 说明 |
|----|------|
| 0 | 初始未报价 |
| 1 | 已报价 |
| 2 | 待发货 |
| 3 | 已发货 |
| 4 | 已收货 |

### 8.6 维修单状态字典
| 值 | 说明 |
|----|------|
| 0 | 待收货 |
| 1 | 维修中 |
| 2 | 维修完成 |

### 8.7 配件订单状态字典
| 值 | 说明 |
|----|------|
| 0 | 待发货 |
| 1 | 已发货 |
| 2 | 已收货 |
| 3 | 已完结 |

### 8.8 配件类型字典
| 值 | 说明 |
|----|------|
| 钣金件 | 钣金类配件 |
| 大灯 | 灯具类配件 |

### 8.9 数据同步类型字典
| 值 | 说明 |
|----|------|
| 1 | 保单 |
| 2 | 配件 |
| 3 | 配件订单 |

### 8.10 同步结果字典
| 值 | 说明 |
|----|------|
| 1 | 成功 |
| 2 | 失败 |

---

## 9. 总结

本需求分析文档详细描述了绿色保单管理平台的所有功能模块、业务流程、数据字段、权限控制等关键信息。系统通过数字化手段实现了保险理赔全流程管理，特别是在配件质量管控方面引入了区块链技术，确保了数据的可信度和可追溯性。系统采用微服务架构设计，具有良好的扩展性和维护性，能够满足保险公司日益增长的业务需求。

### 9.1 核心亮点
1. **完整的业务流程**：从报案到结案的全流程数字化管理
2. **多级审批机制**：预订单的7级审批流程，确保业务规范
3. **质量追溯体系**：基于区块链的配件质量全程追溯
4. **智能搜索功能**：跨模块的全文搜索和搜索建议
5. **数据可视化**：丰富的数据大屏展示，支持业务决策
6. **多租户支持**：SaaS化的多保险公司管理能力

### 9.2 技术特色
1. **Elasticsearch集成**：高效的全文搜索能力
2. **区块链存证**：配件质检数据的不可篡改存储
3. **权限精细化**：基于角色的细粒度权限控制
4. **接口标准化**：RESTful API设计规范

