# 绿色保单管理平台 - 项目模块详细梳理

## 项目概述

绿色保单管理平台是基于若依 (RuoYi) 框架开发的保险业务管理系统，主要服务于保险公司的车险业务管理。该平台通过数字化手段实现保险单、车辆配件、理赔维修等全流程管理。

### 技术架构
- **后端框架**：Spring Boot 2.5.15 + MyBatis Plus
- **数据库**：MySQL 8.0 + Redis + Elasticsearch 7. X
- **安全框架**：Spring Security + JWT
- **区块链**：支持配件数据上链存储

---

## 1. 数据大屏模块 (`/lvguan/dashboard`)

### 1.1 顶部关键指标 (`/topdata`)

**业务逻辑：**
- 统计 5 个关键业务指标：
  1. **保单总数**：查询 `tb_insurance_policy` 表中所有未删除记录的总数
  2. **新增保单数**：统计当天（`create_time` 为当前日期）新增的保单数量
  3. **保费下降总额**：遍历所有保单，根据固定折扣率 15%倒推原保费，计算下降金额并汇总，转换为万元单位（保留 2 位小数）
  4. **出险总数**：查询 `tb_vehicle_order` 表中所有未删除记录的总数
  5. **低碳件供货总数**：统计 `tb_vehicle_accessory` 表（通过 Elasticsearch Repository）的总数

**实现要点：**
- 保费下降计算逻辑：原保费 = 绿车保保费 ÷ 0.85，下降额 = 原保费 - 绿车保保费
- 返回 `TitleVO` 列表，每个包含指标名称和数值

---

### 1.2 累计减损金额情况 (`/lossamount`)

**业务逻辑：**
- 按保险公司分组统计累计减损金额
- 计算规则：减损金额 = 70% × 对外单价 × 数量
- 实现流程：
  1. 获取所有配件和所有保单数据
  2. 遍历每个保单，通过 `insurance_policy_code` 匹配对应的配件
  3. 对每个配件的减损金额进行求和（70% × `external_unit_price` × `quantity`）
  4. 按保险公司进行累加汇总
  5. 返回各保险公司的减损金额列表

**实现要点：**
- 使用 `insurance_policy_code` 作为关联字段连接保单与配件
- 按保险公司进行分组汇总
- 返回 `BrandTypeVO` 列表（brand 字段为保险公司名称，brandCount 字段为减损金额）

---

### 1.3 地区数据分布 (`/regiondata`)

**业务逻辑：**
- 按地区统计保单数量分布
- 实现流程：
  1. 从 `tb_insurance_policy` 表按 `region` 字段分组统计数量
  2. 遍历 `RegionEnum` 枚举（包含 10 个地区：慈溪市、余姚市、镇海区、江北区、海曙区、鄞州区、北仑区、奉化区、宁海县、象山县）
  3. 如果数据库中存在该地区的数据，使用实际数量；否则数量为 0
  4. 保司数量固定为 1（代码中硬编码）

**实现要点：**
- 使用枚举确保地区数据的完整性
- 即使某地区没有数据也会返回，数量为 0
- 返回 `RegionDataVO` 列表，包含地区名称、保司数量、保单数量

---

### 1.4 品牌型号占比 (`/brandtype`)

**业务逻辑：**
- 统计各车辆品牌的保单数量及占比
- 实现流程：
  1. 从 `tb_insurance_policy` 表按 `vehicle_brand` 字段分组统计数量（排除 `vehicle_brand` 为 NULL 的记录）
  2. 计算总保单数量
  3. 计算各品牌占比：品牌数量 ÷ 总数量（保留 3 位小数）
  4. 返回品牌名称和占比

**实现要点：**
- 占比以小数形式返回（如 0.253 表示 25.3%）
- 使用 `BigDecimal` 保证计算精度
- 返回 `BrandTypeVO` 列表（brand 字段为品牌名称，brandCount 字段为占比）

---

### 1.5 配件类型占比 (`/parttype`)

**业务逻辑：**
- 统计各配件类型的数量及占比
- 实现流程：
  1. 从 `tb_vehicle_accessory` 表按 `name`（配件名称）字段分组统计数量
  2. 计算总配件数量
  3. 计算各配件类型占比：该类型数量 ÷ 总数量（保留 3 位小数）
  4. 返回配件类型名称和占比

**实现要点：**
- 使用配件名称（`name`）作为类型维度
- 占比以小数形式返回（如 0.253 表示 25.3%）
- 返回 `PartTypeDistributionVO` 列表（partType 字段为配件名称，ratio 字段为占比）

---

### 1.6 近 30 天保险销售前 5 (`/top5`)

**业务逻辑：**
- 统计近 30 天各保险公司的保费总额，取前 5 名
- 实现流程：
  1. 查询 `insurance_start_time >= 当前日期 - 30天` 的保单，获取保险公司和保费信息
  2. 按保险公司汇总保费（累加 `policy_premium` 字段）
  3. 将保费从元转换为万元（除以 10000，保留 2 位小数）
  4. 按保费金额降序排序
  5. 取前 5 名（处理并列情况）
  6. 查询各公司的保单总数
  7. 返回排名、公司名称、保费金额（万元）、保单数量

**实现要点：**
- 时间范围：`insurance_start_time >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)`
- 单位转换：元 → 万元
- 排序后取前 5 名，处理并列情况
- 返回 `Top5InsuranceSalesVO` 列表（rank、companyName、amount、policyCount）

---

### 1.7 保司保单数据统计 (`/componyAndPolicyData`)

**业务逻辑：**
- 按保险公司统计三类数据：
  1. **保司保单数**：按 `insurance_company` 字段分组统计总数
  2. **保司新增保单数**：统计当天（`DATE(create_time) = DATE(NOW())`）按保险公司分组的新增数量
  3. **保司保费下降总额**：按保险公司汇总保费，根据 15%折扣率倒推原保费，计算下降金额并转换为万元

**实现要点：**
- 使用 MyBatis-Plus 的 `QueryWrapper` 进行分组统计
- 保费下降计算：原保费 = 现保费 ÷ 0.85，下降额 = 原保费 - 现保费，再转换为万元
- 返回 `CompanyAndPolicyVO`，包含三个 `TitleVO` 列表（policyCount、newPolicyCount、premiumDecreaseAmount）

---

## 2. 保单管理模块 (`/lvguan/policy`)

### 2.1 保单列表查询 (`/list`)

**业务逻辑：**
- 支持多条件组合查询，使用 Elasticsearch 进行全文搜索
- 查询条件：
  - 关键词（keyword）：支持模糊搜索保单号、车主姓名、车牌号、VIN 码、追溯码等
  - 保险公司（insuranceCompany）：精确匹配
  - 地区（region）：精确匹配
  - 车型（vehicleModel）：精确匹配
  - 保费范围（policyPremiumMin、policyPremiumMax）：范围查询
  - 时间范围（dateStart、dateEnd）：按创建时间范围查询
  - 状态（status）：保单状态筛选
- 实现流程：
  1. 构建 Elasticsearch 查询条件（BoolQueryBuilder）
  2. 根据用户权限添加部门过滤条件（多租户支持）
  3. 执行分页查询
  4. 返回保单列表和总数

**实现要点：**
- 使用 Elasticsearch 实现全文搜索，支持多字段匹配
- 支持权限过滤，不同保险公司只能查看自己的数据
- 返回分页结果，包含总数信息

---

### 2.2 新增保单 (`/add`)

**业务逻辑：**
- 创建新的保险单记录
- 实现流程：
  1. 验证保险公司是否存在（通过部门表验证）
  2. 检查保单号是否已存在（唯一性校验）
  3. 设置租户 ID（tenantId）用于权限控制
  4. 插入数据库（MySQL）
  5. 同步写入 Elasticsearch（双写策略）
  6. 返回保单信息

**实现要点：**
- 采用同步双写策略：MySQL + Elasticsearch
- 事务保证数据一致性
- 保单号唯一性校验
- 自动设置租户 ID 实现多租户隔离

---

### 2.3 修改保单 (`/update`)

**业务逻辑：**
- 更新保单信息
- 实现流程：
  1. 验证保单是否存在
  2. 更新数据库记录
  3. 同步更新 Elasticsearch
  4. 返回更新后的保单信息

**实现要点：**
- 双写同步更新
- 支持部分字段更新

---

### 2.4 删除保单 (`/deleted`)

**业务逻辑：**
- 软删除保单及相关数据
- 实现流程：
  1. 查询保单信息
  2. 删除关联的出险单（`tb_vehicle_order`）
  3. 删除关联的配件（`tb_vehicle_accessory`）
  4. 软删除保单（设置 `deleted = 1`）
  5. 同步删除 Elasticsearch 中的记录

**实现要点：**
- 级联删除关联数据
- 软删除机制，数据可恢复
- 同步删除 Elasticsearch 数据

---

### 2.5 保单文件管理

**业务逻辑：**
- **上传保单文件** (`/add/file`)：上传电子保单 PDF 文件，存储文件路径
- **获取保单文件** (`/get/file`)：根据保单 ID 下载电子保单 PDF
- **上传附件** (`/add/attachment`)：上传保单相关附件
- **获取附件** (`/get/attachment`)：下载保单附件

**实现要点：**
- 文件存储在服务器本地
- 通过文件 ID 或路径访问文件
- 支持文件下载

---

### 2.6 保单导入导出

**业务逻辑：**
- **导入保单** (`/import`)：
  1. 验证 Excel 文件格式（. Xls、. Xlsx）
  2. 解析 Excel 数据
  3. 批量验证数据（保单号唯一性、必填字段等）
  4. 批量插入数据库
  5. 批量同步到 Elasticsearch
  6. 返回导入结果（成功数、失败数、失败详情）

- **导出保单** (`/export`)：
  1. 根据查询条件筛选数据
  2. 转换为导出格式
  3. 生成 Excel 文件
  4. 返回文件下载

**实现要点：**
- 导入支持批量处理，事务保证一致性
- 导入失败时提供详细错误信息
- 导出支持条件筛选

---

### 2.7 其他功能

- **根据车主姓名查询** (`/getbyname`)：按车主姓名筛选，只返回状态为 1 的保单
- **获取保单标题栏** (`/get/title`)：返回保单类型和保单状态列表，用于下拉选择
- **获取保单公司列表** (`/get/policyCompany`)：返回所有保险公司列表

---

## 3. 报案管理模块 (`/lvguan/claim`)

### 3.1 报案列表查询 (`/list`)

**业务逻辑：**
- 支持多条件查询报案信息
- 查询条件：
  - 关键词（keyword）：支持模糊搜索
  - 手机号（phone）：仅 customer 角色用户可查询
  - 状态（status）：0-待接单，1-送修中，2-已完结
  - 保司名称（companyName）：管理员可指定，非管理员自动从用户部门获取
- 返回报案基本信息、关联保单信息、报案状态

**实现要点：**
- 权限控制：不同角色看到的数据不同
- 自动关联保单信息

---

### 3.2 报案详情查询 (`/detail`)

**业务逻辑：**
- 支持通过报案 ID 或报案编号查询
- 返回信息：
  - 报案基本信息
  - 关联保单完整信息
  - 报案照片列表
  - 关联订单信息（如有）：维修厂名称、地址、电话

**实现要点：**
- 关联查询多张表数据
- 返回完整的报案详情

---

### 3.3 新增报案 (`/insert`)

**业务逻辑：**
- 创建新的报案记录
- 必填字段：
  - 保单号（insurancePolicyCode）：必须关联已存在的保单
  - 事故描述（accidentDescribe）
  - 事故地点（accidentPlace）
  - 出险时间（handleTime）
  - 处理方式（treatmentWay）：0-无需换件，1-换件
  - 照片文件（photoFiles）：至少一张
  - 引导员姓名（guideName）
- 自动生成：
  - 报案编号（claimCode）：格式 "CLAIM-" + 时间戳
  - 车牌号：从关联保单自动获取
- 初始状态：创建时默认状态为"0"（待接单）

**实现要点：**
- 验证保单是否存在
- 自动生成报案编号
- 保存报案照片

---

### 3.4 修改报案 (`/update`)

**业务逻辑：**
- 更新报案信息
- 可修改字段：
  - 事故描述、事故地点、处理方式、出险时间、状态
- 业务规则：
  - 如果处理方式改为"0"（无需换件），状态自动设置为"2"（已完结）
  - 否则使用传入的状态值

**实现要点：**
- 状态自动更新逻辑
- 支持部分字段更新

---

### 3.5 更新报案状态 (`/updateStatus`)

**业务逻辑：**
- 通过报案编号（claimCode）更新状态
- 状态枚举：
  - 0：待接单（PENDING）
  - 1：送修中（REPAIRING）
  - 2：已完结（COMPLETED）

**实现要点：**
- 状态流转控制
- 支持状态更新

---

## 4. 预订单管理模块 (`/lvguan/preorder`)

### 4.1 预订单列表查询 (`/list`)

**业务逻辑：**
- 支持按预订单号和状态查询
- 使用 Elasticsearch 进行搜索
- 返回预订单基本信息、状态、关联信息

**实现要点：**
- Elasticsearch 全文搜索
- 分页查询
- 权限过滤

---

### 4.2 预订单详情查询 (`/detail`)

**业务逻辑：**
- 根据预订单 ID 查询详细信息
- 返回信息：
  - 预订单基本信息
  - 关联保单信息
  - 关联报案信息
  - 预订单配件列表
  - 预订单状态流转历史

**实现要点：**
- 关联查询多表数据
- 返回完整预订单信息

---

### 4.3 新增预订单 (`/add`)

**业务逻辑：**
- 创建新的预订单
- 实现流程：
  1. 根据报案号查询案件（`tb_insurance_claim`）
  2. 验证案件是否存在
  3. 根据报案中的保单号查询保单（`tb_insurance_policy`）
  4. 验证保单是否存在
  5. 查询对应保司，设置租户 ID（tenantId）
  6. 创建预订单记录（初始状态为 0）
  7. 保存预订单配件列表（`tb_insurance_preorder_accessory`）
  8. 配件对比和保存（`compareAndSave` 方法）

**实现要点：**
- 关联报案和保单
- 自动设置租户 ID
- 配件信息对比和保存
- 事务保证数据一致性

---

### 4.4 修改预订单 (`/update`)

**业务逻辑：**
- 更新预订单信息
- 支持更新预订单基本信息和配件列表
- 状态流转：
  - 0：初始状态
  - 1：销售部第一次确认
  - 2：采购部下单
  - 3：供应商报价
  - 4：采购部第一次确认
  - 5：销售部报价
  - 6：保司确认
  - 7：销售部第二次确认

**实现要点：**
- 状态流转控制
- 配件列表更新
- 事务保证一致性

---

## 5. 维修单管理模块 (`/lvguan/repair`)

### 5.1 维修单列表查询 (`/list`)

**业务逻辑：**
- 支持多条件查询
- 查询条件：维修单 ID、预订单号、状态、维修单号、接收人等
- 使用 Elasticsearch 进行搜索
- 返回维修单列表信息

**实现要点：**
- Elasticsearch 全文搜索
- 分页查询
- 按创建时间倒序

---

### 5.2 维修单详情查询 (`/detail`)

**业务逻辑：**
- 根据维修单 ID 查询详细信息
- 返回信息：
  - 维修单基本信息
  - 关联预订单信息
  - 关联保单信息
  - 配件列表及配件图片
  - 维修照片：
    - 周围照片（类型 1，多张）
    - 损坏照片（类型 2，单张）
    - 仪表盘照片（类型 3，单张）
    - 完成周围照片（类型 4，多张）
    - 完成损坏照片（类型 5，单张）
    - 完成仪表盘照片（类型 6，单张）

**实现要点：**
- 关联查询多表数据
- 分类查询维修照片
- 返回完整维修单信息

---

### 5.3 新增维修单 (`POST /`)

**业务逻辑：**
- 创建新的维修单
- 实现流程：
  1. 验证预订单是否存在
  2. 创建维修单记录（初始状态为 0-待收货）
  3. 保存维修照片
  4. 返回维修单编号

**实现要点：**
- 关联预订单
- 保存维修照片
- 初始状态设置

---

### 5.4 修改维修单 (`PUT /`)

**业务逻辑：**
- 更新维修单信息
- 支持更新维修单基本信息和状态
- 状态流转：
  - 0：待收货
  - 1：维修中
  - 2：维修完成

**实现要点：**
- 状态流转控制
- 支持信息更新

---

### 5.5 上传配件图片 (`/uploadAccessoryPhoto`)

**业务逻辑：**
- 批量上传维修单中的配件图片
- 实现流程：
  1. 接收配件图片列表
  2. 验证维修单和配件是否存在
  3. 保存配件图片路径
  4. 更新配件图片字段

**实现要点：**
- 批量处理
- 关联配件和维修单

---

### 5.6 更新配件状态 (`/updateAccessoryStatus`)

**业务逻辑：**
- 更新维修单中配件的状态
- 实现流程：
  1. 验证维修单和配件是否存在
  2. 更新配件状态
  3. 同步更新相关订单状态

**实现要点：**
- 状态更新
- 关联状态同步

---

### 5.7 删除维修单 (`DELETE /{ids}`)

**业务逻辑：**
- 批量删除维修单
- 实现流程：
  1. 验证维修单是否存在
  2. 删除关联的维修照片
  3. 软删除维修单

**实现要点：**
- 批量删除
- 级联删除关联数据

---

## 6. 配件管理模块 (`/lvguan/accessory`)

### 6.1 配件列表查询 (`/list`)

**业务逻辑：**
- 支持关键词和时间范围查询
- 使用 Elasticsearch 进行全文搜索
- 搜索字段：OE 码（oeCode）等
- 返回配件基本信息、状态、关联信息

**实现要点：**
- Elasticsearch 全文搜索
- 分页查询
- 权限过滤

---

### 6.2 配件详情查询 (`/detail`)

**业务逻辑：**
- 根据配件 ID 查询详细信息
- 返回配件完整信息，包括：
  - 基本信息（名称、OE 码、车型、制造商等）
  - 质检信息（前置检、抽检、许可检）
  - 区块链信息（Hash 值）
  - 图片信息
  - 关联订单信息

**实现要点：**
- 关联查询多表数据
- 返回完整配件信息

---

### 6.3 新增配件 (`/add`)

**业务逻辑：**
- 创建新的配件记录
- 实现流程：
  1. 验证必填字段
  2. 设置初始状态（0-初始状态）
  3. 插入数据库
  4. 同步写入 Elasticsearch
  5. 返回配件信息

**实现要点：**
- 双写策略
- 初始状态设置
- 事务保证一致性

---

### 6.4 修改配件 (`/update`)

**业务逻辑：**
- 更新配件信息
- 实现流程：
  1. 验证配件是否存在
  2. 更新数据库记录
  3. 同步更新 Elasticsearch
  4. 返回更新后的配件信息

**实现要点：**
- 双写同步更新
- 支持部分字段更新

---

### 6.5 删除配件 (`DELETE /{id}`)

**业务逻辑：**
- 删除配件记录
- 实现流程：
  1. 验证配件是否存在
  2. 删除 Elasticsearch 中的记录
  3. 软删除数据库记录（设置 `deleted = 1`）

**实现要点：**
- 软删除机制
- 同步删除 Elasticsearch

---

### 6.6 配件图片管理

**业务逻辑：**
- **上传配件图片** (`/add/file`)：上传配件图片，存储文件路径
- **下载配件图片** (`/get/file`)：根据配件 ID 下载配件图片

**实现要点：**
- 文件存储在服务器本地
- 通过文件 ID 访问文件

---

### 6.7 配件质检状态更新 (`/updateStatus`)

**业务逻辑：**
- 更新配件的质检状态
- 质检阶段：
  - 0：前置检（preQuality）
  - 1：抽检（sampling）
  - 2：许可检（permitTest）
- 实现流程：
  1. 根据配件 ID 查询配件信息
  2. 获取供应商名称
  3. 调用区块链服务上传数据，获取交易 Hash
  4. 根据状态更新对应的 Hash 字段和数据字段
  5. 更新配件状态
  6. 同步更新 Elasticsearch
  7. 返回交易 Hash

**实现要点：**
- 区块链数据上链
- 不同质检阶段对应不同的 Hash 字段
- 状态更新后同步相关订单状态

---

### 6.8 配件质检信息更新 (`/updateInspectInfo`)

**业务逻辑：**
- 更新配件的质检详细信息
- 质检字段：
  - 可见表面（visibleSurface）
  - 漆面厚度测量（paintThicknessMeasurement）
  - 安装检验（fitmentInspection）
  - 灯具外观（lampAppearance）
  - 灯具通电（lampPowerOn）
- 实现流程：
  1. 验证用户是否为供应商（仅供应商可完成质检）
  2. 查询配件信息
  3. 更新质检字段
  4. 调用区块链服务上传数据，获取前置检 Hash
  5. 保存前置检 Hash 和数据
  6. 更新数据库

**实现要点：**
- 权限控制：仅供应商可操作
- 区块链数据上链
- 保存质检数据

---

### 6.9 获取区块链详情 (`/getBlockChainDetails`)

**业务逻辑：**
- 根据交易 Hash 和配件 ID 查询区块链详情
- 返回区块链交易信息，包括：
  - 交易 Hash
  - 区块信息
  - 交易时间
  - 数据内容

**实现要点：**
- 调用区块链服务查询
- 返回区块链详情

---

### 6.10 配件附件管理

**业务逻辑：**
- **上传附件** (`/add/attachment`)：上传配件相关附件
- **下载附件** (`/get/attachement`)：下载配件附件

**实现要点：**
- 文件存储
- 文件下载

---

### 6.11 配件物流状态更新

**业务逻辑：**
- **单个更新** (`/updateDeliveryStatus`)：更新单个配件的物流状态
- **批量更新** (`/updateAccessoryListStatus`)：批量更新多个配件的物流状态
- 物流状态：
  - 1：待发货
  - 2：已发货
  - 3：已收货
- 实现流程：
  1. 更新配件物流状态和物流单号（如有）
  2. 更新关联的配件订单状态
  3. 更新关联的供应商订单状态
  4. 同步更新 Elasticsearch

**实现要点：**
- 状态联动更新
- 批量处理支持
- 关联订单状态同步

---

## 7. 配件订单管理模块 (`/lvguan/accessoryOrder`)

### 7.1 配件订单列表查询 (`/list`)

**业务逻辑：**
- 支持关键词、时间范围、状态查询
- 使用 Elasticsearch 进行全文搜索
- 搜索字段：保单号、VIN 码、车牌号、短信内容等
- 返回配件订单基本信息、状态、关联信息

**实现要点：**
- Elasticsearch 全文搜索
- 分页查询
- 权限过滤

---

### 7.2 配件订单详情查询 (`GET /{id}`)

**业务逻辑：**
- 根据配件订单 ID 查询详细信息
- 返回信息：
  - 订单基本信息
  - 车主信息（OwnerInformation）
  - 案件信息（CaseInformation）
  - 事故信息（AccidentInformation）
  - 配件信息列表（PartsInformation）
  - 维修单照片

**实现要点：**
- 关联查询多表数据
- 返回完整订单信息

---

### 7.3 新增配件订单 (`/add`)

**业务逻辑：**
- 创建新的配件订单
- 实现流程：
  1. 验证必填字段
  2. 设置初始状态（0-待发货）
  3. 插入数据库
  4. 同步写入 Elasticsearch
  5. 返回订单信息

**实现要点：**
- 双写策略
- 初始状态设置
- 事务保证一致性

---

### 7.4 修改配件订单 (`/update`)

**业务逻辑：**
- 更新配件订单信息
- 实现流程：
  1. 验证订单是否存在
  2. 更新数据库记录
  3. 同步更新 Elasticsearch
  4. 返回更新后的订单信息

**实现要点：**
- 双写同步更新
- 支持部分字段更新

---

### 7.5 删除配件订单 (`/delete`)

**业务逻辑：**
- 删除配件订单
- 实现流程：
  1. 验证订单是否存在
  2. 软删除数据库记录
  3. 同步删除 Elasticsearch 中的记录

**实现要点：**
- 软删除机制
- 同步删除 Elasticsearch

---

### 7.6 维修单照片管理

**业务逻辑：**
- **上传维修单照片** (`/add/file`)：上传维修单照片，存储文件路径
- **下载维修单照片** (`/get/file`)：根据订单 ID 下载维修单照片

**实现要点：**
- 文件存储
- 文件下载

---

### 7.7 配件订单附件管理

**业务逻辑：**
- **上传附件** (`/add/attachment`)：上传订单相关附件
- **下载附件** (`/get/attachment`)：下载订单附件

**实现要点：**
- 文件存储
- 文件下载

---

### 7.8 获取供应商列表 (`/getProvider`)

**业务逻辑：**
- 返回所有供应商列表
- 用于下拉选择

**实现要点：**
- 从部门表查询供应商
- 返回供应商列表

---

## 8. 供应商订单管理模块 (`/providerorder/order`)

### 8.1 供应商订单列表查询 (`/list`)

**业务逻辑：**
- 支持关键词和时间范围查询
- 使用 Elasticsearch 进行搜索
- 返回供应商订单列表

**实现要点：**
- Elasticsearch 全文搜索
- 分页查询
- 权限过滤

---

### 8.2 供应商订单详情查询 (`GET /{id}`)

**业务逻辑：**
- 根据供应商订单 ID 查询详细信息
- 返回订单完整信息，包括：
  - 订单基本信息
  - 关联配件信息
  - 报价信息
  - 状态信息

**实现要点：**
- 关联查询多表数据
- 返回完整订单信息

---

### 8.3 新增供应商订单 (`POST /`)

**业务逻辑：**
- 创建新的供应商订单
- 实现流程：
  1. 验证必填字段
  2. 设置初始状态（0-初始未报价）
  3. 插入数据库
  4. 同步写入 Elasticsearch
  5. 返回订单信息

**实现要点：**
- 双写策略
- 初始状态设置
- 事务保证一致性

---

### 8.4 修改供应商订单 (`PUT /`)

**业务逻辑：**
- 更新供应商订单信息
- 支持更新报价、状态等信息
- 状态流转：
  - 0：初始未报价
  - 1：已报价
  - 2：待发货
  - 3：已发货
  - 4：已收货

**实现要点：**
- 状态流转控制
- 双写同步更新

---

### 8.5 删除供应商订单 (`DELETE /{ids}`)

**业务逻辑：**
- 批量删除供应商订单
- 实现流程：
  1. 验证订单是否存在
  2. 软删除数据库记录
  3. 同步删除 Elasticsearch 中的记录

**实现要点：**
- 批量删除
- 软删除机制
- 同步删除 Elasticsearch

---

## 9. 保险公司管理模块 (`/lvguan/company`)

### 9.1 获取我的保单保司电话 (`/phones`)

**业务逻辑：**
- 根据当前用户手机号查询该用户所有保单对应的保险公司电话
- 实现流程：
  1. 根据手机号查询保单列表
  2. 获取保单对应的保险公司
  3. 查询保险公司的联系电话
  4. 去重返回保险公司电话列表

**实现要点：**
- 关联查询保单和保险公司
- 数据去重
- 权限控制

---

### 9.2 根据保单 ID 获取保司电话 (`/phone`)

**业务逻辑：**
- 根据保单 ID 查询对应的保险公司电话
- 实现流程：
  1. 根据保单 ID 查询保单信息
  2. 获取保险公司名称
  3. 查询保险公司的联系电话
  4. 返回保险公司电话信息

**实现要点：**
- 关联查询
- 返回保司电话

---

## 10. 售后服务记录模块 (`/lvguan/afterSalesService/`)

### 10.1 售后服务列表查询 (`/list`)

**业务逻辑：**
- 查询所有售后服务记录列表
- 支持分页查询
- 返回售后服务记录基本信息

**实现要点：**
- 分页查询
- 返回列表数据

---

### 10.2 售后服务详情查询 (`/detail`)

**业务逻辑：**
- 根据售后服务记录 ID 查询详细信息
- 返回完整的售后服务记录信息

**实现要点：**
- 详情查询
- 返回完整信息

---

### 10.3 新增售后服务 (`/add`)

**业务逻辑：**
- 创建新的售后服务记录
- 实现流程：
  1. 验证必填字段
  2. 插入数据库
  3. 返回售后服务记录信息

**实现要点：**
- 数据验证
- 插入数据库

---

### 10.4 修改售后服务 (`/update`)

**业务逻辑：**
- 更新售后服务记录信息
- 实现流程：
  1. 验证记录是否存在
  2. 更新数据库记录
  3. 返回更新后的记录信息

**实现要点：**
- 数据更新
- 返回更新结果

---

## 11. 全局搜索模块 (`/lvguan/globalSearch`)

### 11.1 全局搜索 (`/`)

**业务逻辑：**
- 根据关键词进行全局搜索，搜索范围包括：
  - 配件（Accessory）
  - 保单（InsurancePolicy）
  - 配件订单（AccessoryOrder）
- 实现流程：
  1. 在 Elasticsearch 中搜索配件（按 OE 码搜索）
  2. 在 Elasticsearch 中搜索保单（按保单号、车主姓名、手机号、车牌号、VIN 码、追溯码搜索）
  3. 在 Elasticsearch 中搜索配件订单（按保单号、VIN 码、车牌号、短信内容搜索）
  4. 合并搜索结果
  5. 返回 `GlobalSearchVO`，包含三类搜索结果

**实现要点：**
- 多索引搜索
- 多字段匹配
- 权限过滤（根据用户部门过滤）
- 返回分类搜索结果

---

### 11.2 搜索提示词 (`/prefixKeyWord`)

**业务逻辑：**
- 根据前缀关键词提供搜索提示词
- 搜索字段：
  - OE 码（oeCode）
  - 案件号（accidentCode）
  - 短信内容（textMessageContent）
  - 保单号（insurancePolicyCode）
  - 追溯码（traceableCode）
  - 车牌号（licensePlateNumber）
  - VIN 码（vin）
  - 车主姓名（vehicleOwnerName）
  - 车主手机号（vehicleOwnerPhonenumber）
- 实现流程：
  1. 在 Elasticsearch 中使用前缀查询（matchPhrasePrefixQuery）
  2. 从搜索结果中提取匹配的字段值
  3. 去重并过滤包含关键词的值
  4. 返回提示词列表（最多 10 条）

**实现要点：**
- 前缀匹配搜索
- 多字段搜索
- 结果去重
- 返回提示词列表

---

## 12. Elasticsearch 同步模块 (`ESController`)

### 12.1 同步保单数据 (`/policy`)

**业务逻辑：**
- 将 MySQL 中的保单数据同步到 Elasticsearch
- 实现流程：
  1. 清空 Elasticsearch 中的保单索引
  2. 从 MySQL 查询所有未删除的保单数据
  3. 批量写入 Elasticsearch
  4. 返回同步结果

**实现要点：**
- 全量同步
- 批量写入
- 数据一致性

---

### 12.2 同步订单数据 (`/order`)

**业务逻辑：**
- 将 MySQL 中的配件订单数据同步到 Elasticsearch
- 实现流程：
  1. 清空 Elasticsearch 中的订单索引
  2. 从 MySQL 查询所有未删除的订单数据
  3. 转换为 Elasticsearch 格式（AccessoryOrderRepositoryDTO）
  4. 批量写入 Elasticsearch
  5. 返回同步结果

**实现要点：**
- 全量同步
- 数据格式转换
- 批量写入

---

### 12.3 同步配件数据 (`/accessory`)

**业务逻辑：**
- 将 MySQL 中的配件数据同步到 Elasticsearch
- 实现流程：
  1. 从 MySQL 查询所有未删除的配件数据
  2. 清空 Elasticsearch 中的配件索引
  3. 批量写入 Elasticsearch
  4. 返回同步结果

**实现要点：**
- 全量同步
- 批量写入
- 数据一致性

---

### 12.4 更新配件订单号 (`/orderNumber`)

**业务逻辑：**
- 根据预订单 ID 更新配件的订单号
- 实现流程：
  1. 查询所有配件订单
  2. 遍历每个订单，获取预订单 ID 和销售订单号
  3. 根据预订单 ID 更新配件的订单号字段
  4. 返回更新结果

**实现要点：**
- 数据修复
- 批量更新

---

## 13. 文件管理模块 (`/system/info`)

### 13.1 通用文件上传 (`/upload`)

**业务逻辑：**
- 上传通用文件
- 实现流程：
  1. 验证文件格式和大小
  2. 上传文件到服务器
  3. 保存文件信息到数据库（`sys_file_info`）
  4. 记录上传用户
  5. 返回文件信息

**实现要点：**
- 文件验证
- 文件存储
- 文件信息记录

---

### 13.2 通用文件下载 (`/download`)

**业务逻辑：**
- 下载通用文件
- 实现流程：
  1. 解析资源路径
  2. 读取文件内容
  3. 设置响应头
  4. 返回文件流

**实现要点：**
- 文件读取
- 文件下载
- 响应头设置

---

## 技术实现总结

### 数据存储策略
1. **MySQL**：主要数据存储，支持事务
2. **Elasticsearch**：全文搜索，支持复杂查询
3. **双写策略**：关键数据同时写入 MySQL 和 Elasticsearch，保证数据一致性

### 权限控制
1. **多租户支持**：通过 `tenantId` 字段实现数据隔离
2. **角色权限**：不同角色看到不同的数据
3. **部门权限**：根据用户部门过滤数据

### 状态管理
1. **状态枚举**：使用 `StatusEnum` 统一管理状态
2. **状态流转**：支持状态流转控制
3. **状态联动**：相关实体的状态会联动更新

### 区块链集成
1. **数据上链**：配件质检数据上链存储
2. **Hash 存储**：存储区块链交易 Hash
3. **数据追溯**：支持通过 Hash 查询区块链详情

### 搜索优化
1. **Elasticsearch 全文搜索**：支持多字段、多条件搜索
2. **前缀搜索**：支持搜索提示词
3. **权限过滤**：搜索结果自动过滤权限

### 文件管理
1. **文件存储**：本地文件系统存储
2. **文件关联**：通过文件 ID 关联业务数据
3. **文件下载**：支持文件下载功能

---

## 数据库表关系

### 核心表关系
- **tb_insurance_policy**（保单表）← **tb_insurance_claim**（报案表）
- **tb_insurance_claim**（报案表）→ **tb_insurance_preorder**（预订单表）
- **tb_insurance_preorder**（预订单表）→ **tb_vehicle_accessory**（配件表）
- **tb_vehicle_accessory**（配件表）← **tb_provider_order**（供应商订单表）
- **tb_insurance_preorder**（预订单表）→ **tb_vehicle_order**（配件订单表）
- **tb_insurance_preorder**（预订单表）→ **tb_insurance_repair**（维修单表）

### 关联字段
- 保单号（`insurance_policy_code`）：关联保单和报案
- 报案号（`claim_code`）：关联报案和预订单
- 预订单 ID（`preorder_id`）：关联预订单和配件、订单、维修单
- 配件 ID（`accessory_id`）：关联配件和供应商订单

---

## 业务流程总结

### 完整业务流程
1. **保单录入** → 创建保单记录
2. **客户报案** → 创建报案记录，关联保单
3. **创建预订单** → 根据报案创建预订单，关联配件
4. **供应商报价** → 创建供应商订单，关联配件
5. **配件质检** → 更新配件质检状态，数据上链
6. **配件发货** → 更新配件物流状态
7. **创建维修单** → 根据预订单创建维修单
8. **维修完成** → 更新维修单状态
9. **案件完结** → 更新报案状态为已完结

### 状态流转
- **预订单状态**：0→1→2→3→4→5→6→7
- **配件状态**：0→1→2→3（初始→待发货→已发货→已收货）
- **配件质检状态**：前置检→抽检→许可检
- **供应商订单状态**：0→1→2→3→4（初始→已报价→待发货→已发货→已收货）
- **维修单状态**：0→1→2（待收货→维修中→维修完成）
- **报案状态**：0→1→2（待接单→送修中→已完结）

---

*本文档基于代码分析生成，详细实现请参考源代码。*