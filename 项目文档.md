# 绿色保单管理平台（lvguan-platform）项目文档

## 1. 项目简介

### 1.1 项目概述
绿色保单管理平台是一个基于Spring Boot + MyBatis Plus的汽车保险理赔配件管理系统，旨在为保险公司提供配件管理、订单处理、质量追溯、数据统计等功能的一体化解决方案。

### 1.2 系统特点
- 支持多保险公司入驻和管理
- 配件全生命周期质量追溯
- 基于区块链的数据存证
- 完整的订单管理和售后跟踪
- 实时数据统计和大屏展示
- 支持Elasticsearch全文检索

## 2. 技术架构

### 2.1 技术栈
- **后端框架**：Spring Boot 2.5.15
- **持久层框架**：MyBatis Plus 3.4.3.4
- **数据库**：MySQL 8.0
- **缓存**：Redis
- **搜索引擎**：Elasticsearch
- **区块链**：区块链数据存证服务
- **API文档**：Swagger 3.0
- **定时任务**：Quartz
- **连接池**：Druid 1.2.23

### 2.2 项目结构
```
lvguan-platform/
├── ruoyi-admin/              # 管理后台模块
│   ├── src/main/java/        # 主程序入口
│   └── src/main/resources/   # 配置文件
├── ruoyi-common/             # 通用工具模块
├── ruoyi-framework/          # 核心框架模块
├── ruoyi-generator/          # 代码生成模块
├── ruoyi-platform/           # 业务模块（绿管平台核心业务）
│   └── src/main/java/com/ruoyi/lvguan/
│       ├── controller/       # 控制器层
│       ├── service/          # 服务层
│       ├── mapper/           # 数据访问层
│       ├── domain/           # 实体类
│       └── repository/       # ES数据访问层
├── ruoyi-quartz/             # 定时任务模块
├── ruoyi-system/             # 系统管理模块
└── sql/                      # 数据库脚本
```

### 2.3 核心依赖
- Spring Boot Starter Web
- Spring Boot Starter Data Redis
- Spring Boot Starter Data Elasticsearch
- MyBatis Plus Boot Starter
- Druid Spring Boot Starter
- JWT (Java JWT)
- FastJSON2
- Apache POI
- Swagger3

## 3. 数据库设计

### 3.1 核心业务表

#### 3.1.1 保险相关表

**tb_insurance_company** - 保险公司信息表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键ID |
| insurance_company_name | varchar(255) | 保司名称 |
| interface_url | varchar(255) | 接口地址 |
| api_key | varchar(255) | APIKey |
| api_secret | varchar(255) | APISecret |
| sync_time | datetime | 同步时间 |
| sync_status | varchar(255) | 同步状态 |

**tb_insurance_policy** - 保险单表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键ID |
| insurance_policy_code | varchar(255) | 保单号 |
| insurance_company | varchar(255) | 保司名称 |
| insurance_policy_type | varchar(255) | 保单类型 |
| traceable_code | varchar(255) | 循寻码 |
| license_plate_number | varchar(255) | 车牌号 |
| vin | varchar(255) | 车架号 |
| brand_type | varchar(255) | 品牌类型 |
| vehicle_owner_name | varchar(255) | 车主姓名 |
| vehicle_owner_phonenumber | varchar(255) | 车主手机号 |
| insurance_start_time | varchar(255) | 保险开始时间 |
| insurance_end_time | varchar(255) | 保险结束时间 |
| insurance_policy_status | varchar(255) | 保单状态 |
| insurance_policy_detail | varchar(255) | 保单详情文件 |

**tb_insurance_claim** - 保险理赔表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键ID |
| claim_code | varchar(255) | 案件号 |
| policy_code | varchar(255) | 保单号 |
| accident_time | datetime | 事故时间 |
| handle_time | datetime | 处理时间 |
| surveyor | varchar(255) | 查勘员 |
| surveyor_phonenumber | varchar(255) | 查勘员电话 |
| handler | varchar(255) | 处理人 |
| handler_phonenumber | varchar(255) | 处理人电话 |
| human_injury | varchar(255) | 是否涉及人伤 |
| accident_describe | text | 事故描述 |
| create_by | int | 创建人 |
| create_time | datetime | 创建时间 |

**tb_insurance_preorder** - 保险预订单表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 预订单id |
| policy_code | varchar(255) | 保单号 |
| claim_code | varchar(255) | 案件号 |
| pre_order_code | varchar(255) | 预订单号 |
| phone | varchar(255) | 联系方式 |
| vehicle_owner_phone | varchar(255) | 车主联系方式 |
| transportation_way | varchar(255) | 运输方式 |
| fix_company_address | varchar(255) | 维修企业地址 |
| paid_way | varchar(255) | 支付方式 |
| is_invoice | int | 是否开票 |
| status | int | 当前状态 |

#### 3.1.2 配件相关表

**tb_vehicle_accessory** - 车辆配件表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| name | varchar(255) | 配件名称 |
| oe_code | varchar(255) | OE码 |
| english_name | varchar(255) | 英文名称 |
| simplified_code | varchar(255) | 简码 |
| mnemonic_code | varchar(255) | 助记码 |
| belonging_subject | varchar(255) | 归属主体 |
| vehicle_model | varchar(255) | 车型 |
| manufacturer | varchar(255) | 厂商单位 |
| vehicle_series | varchar(255) | 车系 |
| brand | varchar(255) | 配件品牌 |
| quality | varchar(255) | 配件品质 |
| warranty_period | date | 质保期 |
| warranty_years | varchar(255) | 质保年限 |
| vehicle_name | varchar(255) | 车名 |
| vehicle_age | varchar(255) | 年代 |
| original_factory_code | varchar(255) | 原厂编码 |
| vehicle_brand | varchar(255) | 车品牌 |
| price | varchar(255) | 价格 |
| external_unit_price | varchar(255) | 对外单价 |
| buy_unit_price | varchar(255) | 采购部单价 |
| provider_unit_price | varchar(255) | 供应商单价 |
| quantity | int | 数量 |
| unit | varchar(255) | 计数单位 |
| amount | varchar(255) | 该配件总价 |
| quality_inspection_time | varchar(255) | 质检时间 |
| visible_surface | varchar(255) | 可视表面 |
| paint_thickness_measurement | varchar(255) | 漆厚测量 |
| metal_plate_thickness | varchar(255) | 金属板厚度 |
| size | varchar(255) | 尺寸 |
| inner_surface | varchar(255) | 内表面 |
| installation_mechanism | varchar(255) | 安装机构 |
| accessory_type | varchar(255) | 配件类型(钣金件or大灯) |
| origin | varchar(255) | 产地 |
| delivery_number | varchar(255) | 物流单号 |
| delivery_status | int | 物流状态 |
| insurance_policy_code | varchar(255) | 保单号 |
| claim_code | varchar(255) | 报案号 |
| vin | varchar(255) | 车架号 |
| plate_number | varchar(255) | 车牌号 |
| policy_id | bigint | 保单id |
| accident_id | bigint | 出险id |
| provider_id | bigint | 供应商id |
| accessory_picture | varchar(255) | 配件图片 |
| attachment | varchar(255) | 附件 |
| status | bigint | 状态 |
| tx_hash | varchar(255) | 区块链哈希 |
| pre_quality_data | text | 前质检数据 |
| sampling_data | text | 抽检数据 |
| permit_test_data | text | 供应商准入数据 |
| pre_quality_hash | varchar(255) | 前质检hash |
| sampling_hash | varchar(255) | 抽检hash |
| permit_test_hash | varchar(255) | 供应商准入hash |
| pre_quality_id | bigint | 前置检员id |
| sampling_id | bigint | 抽检人id |
| permit_test_id | bigint | 供应商准入质检人id |
| preorder_id | varchar(255) | 预订单id |

#### 3.1.3 订单相关表

**tb_vehicle_order** - 车辆配件订单表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | varchar(255) | id |
| text_message_content | text | 报案短信内容 |
| guide_name | varchar(255) | 引导员姓名 |
| guide_receive_time | varchar(255) | 引导员接收时间 |
| guide_arrive_time | varchar(255) | 引导员到达时间 |
| insurance_policy_code | varchar(255) | 保单号 |
| plate_number | varchar(255) | 车牌号 |
| vin | varchar(255) | 车架号 |
| repair_factory | varchar(255) | 送修维修厂 |
| vehicle_model | varchar(255) | 车型 |
| phone | varchar(255) | 联系方式 |
| sales_order_number | varchar(255) | 销售单号 |
| insurance_company | varchar(255) | 保险公司 |
| transport_mode | varchar(255) | 运输方式 |
| repair_factory_address | varchar(255) | 修理厂地址 |
| pay_mode | varchar(255) | 付款方式 |
| is_invoice | boolean | 是否开票 |
| repair_order_file | varchar(255) | 维修单照片 |
| order_id | bigint | 案件id |
| provider_id | bigint | 供应商id |
| policy_id | bigint | 保单id |
| tenant_id | bigint | 租户id |
| attachment | varchar(255) | 附件 |
| amount | varchar(255) | 金额 |
| submit_order_time | datetime | 下单时间 |
| status | int | 订单状态 |
| claim_code | varchar(255) | 报案编号 |
| factory_phone | varchar(255) | 维修厂联系方式 |
| preorder_id | varchar(255) | 预订单id |

#### 3.1.4 维修相关表

**tb_insurance_repair** - 保险维修表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| claim_code | varchar(255) | 案件号 |
| policy_code | varchar(255) | 保单号 |
| repair_factory | varchar(255) | 维修厂 |
| repair_contact | varchar(255) | 维修联系人 |
| repair_contact_phone | varchar(255) | 维修联系方式 |
| repair_start_time | datetime | 维修开始时间 |
| repair_end_time | datetime | 维修结束时间 |
| repair_status | varchar(255) | 维修状态 |
| repair_cost | decimal(10,2) | 维修费用 |
| repair_description | text | 维修描述 |
| create_by | bigint | 创建人 |
| create_time | datetime | 创建时间 |
| update_by | bigint | 更新人 |
| update_time | datetime | 更新时间 |

**tb_insurance_repair_photo** - 保险维修照片表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| repair_id | bigint | 维修ID |
| photo_type | varchar(255) | 照片类型 |
| photo_url | varchar(255) | 照片URL |
| photo_description | varchar(500) | 照片描述 |
| create_by | bigint | 创建人 |
| create_time | datetime | 创建时间 |

#### 3.1.5 其他业务表

**tb_provider_order** - 供应商订单表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| provider_id | bigint | 供应商ID |
| order_code | varchar(255) | 订单编码 |
| order_status | varchar(255) | 订单状态 |
| total_amount | decimal(10,2) | 订单总金额 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

**tb_after_sales_service_record** - 售后服务记录表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| accessory_id | bigint | 配件ID |
| service_type | varchar(255) | 服务类型 |
| service_content | text | 服务内容 |
| service_result | varchar(255) | 服务结果 |
| service_time | datetime | 服务时间 |
| create_by | bigint | 创建人 |
| create_time | datetime | 创建时间 |

**tb_data_sync_record** - 数据同步记录表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | int | 主键ID |
| data_type | varchar(255) | 数据类型（1-保单；2-配件；3-配件订单） |
| insurance_company_id | int | 保司ID |
| sync_time | datetime | 同步时间 |
| sync_data_record_size | int | 同步数据量 |
| sync_result | varchar(255) | 同步结果（1-成功；2-失败） |

**block_chain_upload** - 区块链上传记录表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| tx_hash | varchar(255) | 交易哈希 |
| upload_time | datetime | 上传时间 |
| upload_data | text | 上传数据 |
| upload_result | varchar(255) | 上传结果 |

**sys_file_info** - 系统文件信息表
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| file_name | varchar(255) | 文件名称 |
| file_path | varchar(500) | 文件路径 |
| file_type | varchar(255) | 文件类型 |
| file_size | bigint | 文件大小 |
| upload_time | datetime | 上传时间 |
| upload_user | bigint | 上传用户 |

## 4. 业务模块

### 4.1 保险管理模块
- **保险公司管理**：维护保险公司基本信息和接口配置
- **保单管理**：保单信息的录入、查询、同步
- **理赔管理**：案件信息管理、查勘记录、定损信息
- **预订单管理**：配件预订单创建、状态跟踪

### 4.2 配件管理模块
- **配件信息管理**：配件基础信息、OE码、车型适配
- **库存管理**：配件库存数量、状态跟踪
- **质检管理**：前质检、抽检、供应商准入质检
- **价格管理**：对外单价、采购单价、供应商单价

### 4.3 订单管理模块
- **订单创建**：基于保单/案件创建配件订单
- **订单跟踪**：订单状态流转、物流跟踪
- **订单结算**：订单金额计算、支付方式管理

### 4.4 维修管理模块
- **维修厂管理**：维修厂信息、联系方式
- **维修记录**：维修过程记录、维修照片
- **维修费用**：维修费用计算、审核

### 4.5 供应商管理模块
- **供应商信息**：供应商基础信息、资质管理
- **供应商订单**：供应商订单管理、交付跟踪
- **售后管理**：售后服务记录、质量问题处理

### 4.6 数据统计模块
- **大屏展示**：实时数据统计、图表展示
- **报表生成**：各类业务报表生成和导出
- **数据分析**：减损金额、地区分布、品牌占比等

### 4.7 系统管理模块
- **用户管理**：用户信息、角色权限
- **部门管理**：组织架构、部门人员
- **字典管理**：系统字典维护
- **日志管理**：操作日志、登录日志

## 5. API接口文档

### 5.1 认证方式
所有API接口需要在请求头中携带Token：
```
Authorization: Bearer <token>
```

### 5.2 保险管理接口

#### 5.2.1 保险公司管理
**获取保险公司列表**
```
GET /api/v1/lvguan/insurance/company/list
```

**新增保险公司**
```
POST /api/v1/lvguan/insurance/company
Content-Type: application/json

{
  "insuranceCompanyName": "保险公司名称",
  "interfaceUrl": "接口地址",
  "apiKey": "API密钥",
  "apiSecret": "API秘钥"
}
```

#### 5.2.2 保单管理
**获取保单列表**
```
GET /api/v1/lvguan/insurance/policy/list?pageNum=1&pageSize=10&insurancePolicyCode=保单号
```

**新增保单**
```
POST /api/v1/lvguan/insurance/policy
Content-Type: application/json

{
  "insurancePolicyCode": "保单号",
  "insuranceCompany": "保险公司",
  "insurancePolicyType": "保单类型",
  "licensePlateNumber": "车牌号",
  "vin": "车架号",
  "vehicleOwnerName": "车主姓名",
  "vehicleOwnerPhonenumber": "车主电话"
}
```

#### 5.2.3 理赔管理
**获取理赔列表**
```
GET /api/v1/lvguan/insurance/claim/list
```

**新增理赔记录**
```
POST /api/v1/lvguan/insurance/claim
Content-Type: application/json

{
  "claimCode": "案件号",
  "policyCode": "保单号",
  "accidentTime": "事故时间",
  "surveyor": "查勘员",
  "accidentDescribe": "事故描述"
}
```

### 5.3 配件管理接口

#### 5.3.1 配件信息
**获取配件列表**
```
GET /api/v1/lvguan/accessory/list?pageNum=1&pageSize=10&name=配件名称&oeCode=OE码
```

**新增配件**
```
POST /api/v1/lvguan/accessory
Content-Type: application/json

{
  "name": "配件名称",
  "oeCode": "OE码",
  "vehicleModel": "适用车型",
  "manufacturer": "厂商",
  "quality": "品质",
  "warrantyPeriod": "质保期",
  "quantity": 100,
  "unit": "个"
}
```

**更新配件信息**
```
PUT /api/v1/lvguan/accessory/{id}
Content-Type: application/json

{
  "name": "配件名称",
  "price": "价格"
}
```

#### 5.3.2 配件订单
**获取配件订单列表**
```
GET /api/v1/lvguan/accessory/order/list?pageNum=1&pageSize=10&status=状态
```

**创建配件订单**
```
POST /api/v1/lvguan/accessory/order
Content-Type: application/json

{
  "policyCode": "保单号",
  "claimCode": "案件号",
  "repairFactory": "维修厂",
  "accessoryList": [
    {
      "accessoryId": 1,
      "quantity": 2,
      "unitPrice": "100.00"
    }
  ]
}
```

### 5.4 维修管理接口

#### 5.4.1 维修记录
**获取维修列表**
```
GET /api/v1/lvguan/repair/list?claimCode=案件号
```

**新增维修记录**
```
POST /api/v1/lvguan/repair
Content-Type: application/json

{
  "claimCode": "案件号",
  "policyCode": "保单号",
  "repairFactory": "维修厂",
  "repairContact": "联系人",
  "repairContactPhone": "联系电话",
  "repairDescription": "维修描述"
}
```

#### 5.4.2 维修照片
**上传维修照片**
```
POST /api/v1/lvguan/repair/photo
Content-Type: multipart/form-data

repairId: 维修ID
photoType: 照片类型
file: 照片文件
```

### 5.5 数据统计接口

#### 5.5.1 大屏数据
**获取顶部统计数据**
```
GET /api/v1/lvguan/dashboard/topdata
```

响应示例：
```json
{
  "code": 200,
  "data": [
    {
      "title": "累计减损金额",
      "value": "1284567.89",
      "unit": "元"
    },
    {
      "title": "服务配件数量",
      "value": "25678",
      "unit": "件"
    }
  ]
}
```

**获取地区分布数据**
```
GET /api/v1/lvguan/dashboard/regiondata
```

**获取品牌占比数据**
```
GET /api/v1/lvguan/dashboard/brandtype
```

### 5.6 搜索接口

#### 5.6.1 全局搜索
**全文搜索**
```
GET /api/v1/lvguan/search?q=关键词&type=类型&page=1&size=10
```

参数说明：
- q：搜索关键词
- type：搜索类型（policy-保单，accessory-配件，order-订单）
- page：页码
- size：每页数量

### 5.7 文件管理接口

#### 5.7.1 文件上传
**上传文件**
```
POST /api/v1/lvguan/file/upload
Content-Type: multipart/form-data

file: 文件
type: 文件类型
```

响应示例：
```json
{
  "code": 200,
  "data": {
    "fileId": "文件ID",
    "fileName": "文件名称",
    "filePath": "文件路径",
    "fileUrl": "访问URL"
  }
}
```

## 6. 部署说明

### 6.1 环境要求
- JDK 1.8+
- MySQL 8.0+
- Redis 3.0+
- Elasticsearch 7.0+
- Maven 3.6+

### 6.2 配置文件说明

#### 6.2.1 应用配置
- `application.yml`：基础配置
- `application-dev.yml`：开发环境配置
- `application-test.yml`：测试环境配置

#### 6.2.2 数据库配置
```yaml
spring:
  datasource:
    druid:
      master:
        url: jdbc:mysql://localhost:3306/lvguan_platform?useUnicode=true&characterEncoding=utf8
        username: username
        password: password
```

#### 6.2.3 Redis配置
```yaml
spring:
  redis:
    host: localhost
    port: 6379
    database: 0
    password: password
```

#### 6.2.4 Elasticsearch配置
```yaml
spring:
  elasticsearch:
    rest:
      uris: localhost:9200
```

### 6.3 部署步骤

1. **编译打包**
```bash
mvn clean package -Dmaven.test.skip=true
```

2. **创建数据库**
```sql
CREATE DATABASE lvguan_platform DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;
```

3. **执行数据库脚本**
```bash
mysql -u username -p lvguan_platform < sql/lvguan_platform.sql
```

4. **配置环境变量**
```bash
export DB_URL=jdbc:mysql://localhost:3306/lvguan_platform
export DB_USER=username
export DB_PASSWORD=password
export REDIS_HOST=localhost
export REDIS_PASSWORD=password
```

5. **启动应用**
```bash
java -jar ruoyi-admin.jar --spring.profiles.active=prod
```

### 6.4 Docker部署

1. **构建镜像**
```dockerfile
FROM openjdk:8-jre-slim
COPY ruoyi-admin.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java","-jar","/app.jar"]
```

2. **运行容器**
```bash
docker run -d \
  --name lvguan-platform \
  -p 8080:8080 \
  -e SPRING_PROFILES_ACTIVE=prod \
  -e DB_URL=jdbc:mysql://mysql:3306/lvguan_platform \
  -e DB_USER=username \
  -e DB_PASSWORD=password \
  lvguan-platform:latest
```

### 6.5 监控配置

#### 6.5.1 应用监控
- 访问 `http://localhost:8080/api/v1/druid` 查看数据源监控
- 访问 `http://localhost:8080/api/v1/swagger-ui.html` 查看API文档

#### 6.5.2 日志配置
- 日志路径：`/home/ruoyi/logs/`
- 日志级别：`com.ruoyi: debug`

## 7. 开发指南

### 7.1 代码规范
- 遵循阿里巴巴Java开发手册
- 使用Lombok简化代码
- 统一使用R返回结果包装

### 7.2 接口开发
1. Controller层：负责接口暴露
2. Service层：负责业务逻辑
3. Mapper层：负责数据访问
4. Domain层：实体定义

### 7.3 测试规范
- 单元测试覆盖率不低于70%
- 集成测试覆盖主要业务流程
- 性能测试满足并发要求

### 7.4 版本管理
- 使用Git进行版本控制
- 遵循语义化版本规范
- 主分支：master
- 开发分支：develop
- 功能分支：feature/*

## 8. 常见问题

### 8.1 启动问题
- 检查JDK版本是否为1.8+
- 检查数据库连接配置
- 检查Redis连接配置

### 8.2 性能优化
- 调整数据库连接池参数
- 配置合适的JVM参数
- 使用Redis缓存热点数据

### 8.3 安全建议
- 定期更新依赖版本
- 使用HTTPS传输
- 配置防火墙规则
- 定期备份数据

## 9. 更新日志

### v3.8.9 (2025-12-10)
- 添加配件订单对外单价字段
- 优化订单处理逻辑
- 修复NullPointerException问题
- 完善测试用例

### v3.8.8 (2025-12-05)
- 新增区块链数据存证功能
- 优化Elasticsearch搜索性能
- 完善售后服务流程

### v3.8.7 (2025-11-20)
- 新增数据大屏展示功能
- 优化配件质检流程
- 支持批量导入配件信息

## 10. 技术支持

如有问题，请联系：
- 邮箱：support@lvguan.com
- 电话：400-XXX-XXXX
- 文档：https://docs.lvguan.com